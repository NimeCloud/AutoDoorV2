<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Kontrol Paneli</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            background-color: #f0f2f5;
        }

        .container {
            background: white;
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .screen {
            display: none;
            width: 100%;
        }

        #connectScreen {
            display: block;
        }

        button,
        select {
            width: 100%;
            padding: 15px;
            background-color: #007AFF;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            border-radius: 10px;
            transition: background-color 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover,
        select:hover {
            background-color: #005ecb;
            /* Diğer panel ile tutarlı mavi tonu */
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            color: #8e8e93;
            /* <-- YENİ EKLENEN SATIR: Pasif sekme rengi (standart bir gri) */

        }

        .tab-button.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #333;
        }

        .input-group input,
        .input-group select {
            box-sizing: border-box;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .slider-wrapper .value {
            font-weight: bold;
            color: #007AFF;
        }

        .device-name-display {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1c1c1e;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 15px;
            /* Takma ad kutusu ile diğer bilgiler arasına boşluk koy */
            flex-grow: 1;
            /* Mümkün olan tüm alanı kapla */
            text-align: left;
        }

        .device-info input {
            width: 180px;
            /* Genişliği artırdık */
            flex-shrink: 0;
            padding: 8px;
            /* Dikey boşluğu artırarak daha dengeli hale getirdik */
            font-size: 15px;
            /* Yazı tipini biraz büyüttük */
        }

        .device-details {
            display: flex;
            flex-direction: column;
            /* Cihaz adı ve MAC adresini alt alta sırala */
            line-height: 1.3;
        }

        .vehicle-name {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }

        .mac-address {
            font-size: 12px;
            color: #888;
        }

        .device-actions {
            flex-shrink: 0;
            /* Butonların da küçülmesini engelle */
        }

        .device-actions button {
            font-size: 11px;
            /* Yazı tipini küçülttük */
            font-weight: 500;
            /* Yazıyı biraz incelttik */
            padding: 6px 10px;
            /* İç boşluğu azalttık */
            width: auto;
            margin-left: 5px;
            border-radius: 5px;
            /* Köşeleri daha az yuvarlak yaptık */
            margin-bottom: 0;
            /* Alt boşluğu kaldırdık */
        }

        .btn-delete {
            background-color: #f44336 !important;
        }

        .warning-text {
            display: none;
            /* Varsayılan olarak gizli */
            color: #D32F2F;
            /* Koyu kırmızı renk */
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            padding: 10px;
            background-color: #FFEBEE;
            /* Çok açık kırmızı arka plan */
            border-radius: 6px;
            text-align: left;
        }


        .scan-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-scan {
            flex-shrink: 0;
            /* Butonun boyutu sabit kalsın */
            width: auto;
            padding: 10px 15px;
            font-size: 14px;
            background-color: #28a745 !important;
            /* Yeşil renk */
            margin-bottom: 0;
        }

        .btn-scan:hover {
            background-color: #218838 !important;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            display: none;
            /* Varsayılan olarak gizli */
        }

        .progress-bar {
            height: 100%;
            width: 100%;
            background-color: #007AFF;
            border-radius: 5px;
            transition: width 0.5s ease-out;
            /* Genişlik değişimini yumuşat */
        }

        /* JavaScript ile bu class eklendiğinde animasyon başlayacak */
        .scanning .progress-container {
            display: block !important;
        }

        .scanning .progress-bar {
            animation: scanProgressAnimation 10s linear forwards;
            display: block !important;

        }

        @keyframes scanProgressAnimation {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }




        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 450px;
            border-radius: 10px;
            text-align: left;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">

        <div id="foundDeviceModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal()">&times;</span>
                <h3 id="modalTitle">Araç Bulundu</h3>
                <div class="input-group">
                    <label>Araç Adı:</label>
                    <p id="foundDeviceName" style="font-weight:bold;"></p>
                </div>
                <div class="input-group">
                    <label>MAC Adresi:</label>
                    <p id="foundDeviceMac"></p>
                </div>
                <div class="input-group">
                    <label for="nicknameInput">Bir Takma İsim Belirleyin:</label>
                    <input type="text" id="nicknameInput" placeholder="Örn: Mavi Araba">
                </div>
                <button id="pairButton">Onayla</button>
            </div>
        </div>

        <h2 id="deviceNameDisplay" style="display: none;">Gate Kontrol Paneli</h2>

        <div id="connectScreen" class="screen">
            <button id="connectButton">Gate Cihazına Bağlan</button>
        </div>

        <div id="pinScreen" class="screen">
            <p>Ayarlara erişmek için lütfen PIN girin:</p>
            <div class="input-group">
                <label for="pinInput">PIN:</label>
                <input type="password" id="pinInput" maxlength="4" pattern="\d{4}" inputmode="numeric" />
            </div>
            <button id="submitPinButton">PIN'i Gönder</button>
        </div>

        <div id="mainContent" class="screen">
            <div class="tabs">
                <button id="tabBtnDeviceMgmt" class="tab-button" onclick="showTab('deviceManagementScreen', this)">Araç
                    Yönetimi</button>
                <button id="tabBtnSettings" class="tab-button" onclick="showTab('settingsScreen', this)">Gate
                    Ayarları</button>
            </div>

            <div id="deviceManagementScreen" class="tab-content">
                <h3>Eşleşmiş Araçlar</h3>
                <div class="scan-container">
                    <button id="scanButton" class="btn-scan">Yakındaki Araçları Tara</button>
                    <div id="scanProgressContainer" class="progress-container">
                        <div id="scanProgressBar" class="progress-bar"></div>
                    </div>
                </div>
                <div id="deviceList"><i>Liste Yükleniyor...</i></div>
            </div>

            <div id="settingsScreen" class="tab-content">


                <h3>Gate Ayarları</h3>
                <div class="input-group">
                    <label for="gateDeviceNameInput">Cihaz Adı:</label>
                    <input type="text" id="gateDeviceNameInput" />
                </div>
                <div class="input-group">

                    <label for="newPinInput">PIN <span id="pinRemoveHint"
                            style="font-size:12px; color:#888;"></span></label>
                    <input type="text" id="newPinInput" maxlength="4" pattern="\d{0,4}" inputmode="numeric"
                        placeholder="Yeni PIN (4 hane)" />
                    <span id="pinStatus" style="font-size: 12px; margin-top: 5px; display: block;"></span>
                </div>


                <div class="input-group">
                    <label for="operationModeSelect">Çalışma Modu:</label>
                    <select id="operationModeSelect">
                        <option value="0">Normal (Otomatik)</option>
                        <option value="1">Sürekli Açık Tut</option>
                        <option value="2">Sürekli Kapalı Tut</option>
                        <option value="3">Servis Dışı</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="authRequiredCheckbox" style="width:auto; vertical-align: middle;">
                        Yüksek Güvenlik Modu (Önerilir)
                    </label>
                    <span id="securityWarning" class="warning-text">
                        ⚠️ Güvenlik devre dışı! Bu modda herhangi bir araç kapıyı çalıştırabilir.
                    </span>
                </div>
                <div class="input-group">
                    <label>Oto. Kapanma Süresi (Sinyal Kaybı): <span id="closeTimeoutValue">30</span>s</label>
                    <input type="range" id="closeTimeoutSlider" min="10" max="600" step="5">
                </div>
                <div class="input-group">
                    <label>Kapanma Öncesi Uyarı Süresi: <span id="preCloseWarningValue">5</span>s</label>
                    <input type="range" id="preCloseWarningSlider" min="1" max="15" step="1">
                </div>
                <button id="saveSettingsButton">Ayarları Kaydet</button>
            </div>

            <button id="disconnectButton" style="background-color:#6c757d; margin-top: 20px;">Bağlantıyı Kes</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        // UUIDs
        const GATE_SERVICE_UUID = "e3a1b2f0-5f4d-4c8a-bd2f-8e6a7f3b9c0d";
        const CHAR_SETTINGS_UUID = "a1d2f3e4-5678-4b9a-b3c2-9d8e7f6a5b4c";
        const CHAR_PIN_AUTH_UUID = "b2c3d4e5-6789-4f0b-c1d2-a3b4c5d6e7f8";
        const CHAR_DEVICE_MGMT_UUID = "d4e5f6a7-8901-4b2d-c3e4-f5a6b7c8d9e0";
        const CHAR_STATUS_UUID = "c3d4e5f6-7890-4a1c-b2d3-e4f5a6b7c8d9";

        // Global variables
        let bleDevice, settingsCharacteristic, pinAuthCharacteristic, deviceMgmtCharacteristic, statusCharacteristic;
        let toastTimeout;
        let isPinInputModified = false;
        let deviceHasPin = false; // <<< YENİ SATIR



        // UI Elements
        const ui = {
            connectButton: document.getElementById('connectButton'),
            disconnectButton: document.getElementById('disconnectButton'),
            deviceNameDisplay: document.getElementById('deviceNameDisplay'),
            connectScreen: document.getElementById('connectScreen'),
            pinScreen: document.getElementById('pinScreen'),
            mainContent: document.getElementById('mainContent'),
            pinInput: document.getElementById('pinInput'),
            submitPinButton: document.getElementById('submitPinButton'),
            deviceList: document.getElementById('deviceList'),
            gateDeviceNameInput: document.getElementById('gateDeviceNameInput'), // Artık HTML'de var
            closeTimeoutSlider: document.getElementById('closeTimeoutSlider'),
            closeTimeoutValue: document.getElementById('closeTimeoutValue'),
            preCloseWarningSlider: document.getElementById('preCloseWarningSlider'),
            preCloseWarningValue: document.getElementById('preCloseWarningValue'),
            operationModeSelect: document.getElementById('operationModeSelect'),
            authRequiredCheckbox: document.getElementById('authRequiredCheckbox'),
            securityWarning: document.getElementById('securityWarning'), // <<< YENİ SATIR

            saveSettingsButton: document.getElementById('saveSettingsButton'),
            toast: document.getElementById('toast'),
            newPinInput: document.getElementById('newPinInput'),
            pinStatus: document.getElementById('pinStatus'),

            scanButton: document.getElementById('scanButton'),
            scanProgressBar: document.getElementById('scanProgressBar'),
            scanProgressContainer: document.getElementById('scanProgressContainer'),
            foundDeviceModal: document.getElementById('foundDeviceModal')

        };

        // Event Listeners
        ui.connectButton.addEventListener('click', connectToDevice);
        ui.disconnectButton.addEventListener('click', disconnectFromDevice);
        ui.submitPinButton.addEventListener('click', submitPin);
        ui.saveSettingsButton.addEventListener('click', writeGateSettings);
        ui.closeTimeoutSlider.addEventListener('input', e => ui.closeTimeoutValue.innerText = e.target.value);
        ui.preCloseWarningSlider.addEventListener('input', e => ui.preCloseWarningValue.innerText = e.target.value);

        ui.newPinInput.addEventListener('input', () => { isPinInputModified = true; });
        ui.authRequiredCheckbox.addEventListener('change', updateSecurityWarning);

        ui.scanButton.addEventListener('click', startVehicleScan);


        // --- Core Functions ---

        function closeModal() { ui.foundDeviceModal.style.display = 'none'; }



        async function startDiscoveryScan() {
            showToast("Tarama başlatılıyor...", "info");
            await writeToDeviceMgmtChar({ action: "start_discovery_scan" });
        }


        function handleStatusNotifications(event) {
            const rawData = new TextDecoder().decode(event.target.value);
            let data;

            // Gelen verinin JSON olup olmadığını anlamak için ayrıştırmayı dene
            try {
                data = JSON.parse(rawData);
            } catch (e) {
                // Eğer JSON değilse, bu "AUTH_SUCCESS" gibi basit bir metin mesajıdır.
                // Bu panelde PIN yönetimi olmadığı için şimdilik sadece loglayabiliriz.
                console.log("Status update (text):", rawData);
                // Örnek: if (rawData === "SETTINGS_UPDATED") { showToast("Ayarlar güncellendi!"); }
                return; // Metin tabanlı bildirimden sonra işlemi bitir.
            }

            // Eğer veri JSON ise ve içinde bir "event" anahtarı varsa...
            if (data && data.event) {

                switch (data.event) {

                    case 'device_found':

                        finishScanUI(true); 

                        // Mevcut cihaz listesini al
                        deviceMgmtCharacteristic.readValue()
                            .then(value => {
                                const devices = JSON.parse(new TextDecoder().decode(value));
                                const existingDevice = devices.find(device => device.mac === data.mac);
                                const isPaired = !!existingDevice;

                                // Modal başlık ve buton metnini ayarla
                                const modalTitle = document.getElementById('modalTitle');
                                const pairButton = document.getElementById('pairButton');

                                if (isPaired) {
                                    modalTitle.innerText = "Kayıtlı Araç Bulundu";
                                    pairButton.innerText = "Güncelle";
                                } else {
                                    modalTitle.innerText = "Yeni Araç Bulundu";
                                    pairButton.innerText = "Ekle ve Eşleştir";
                                }

                                // Modal içeriğini doldur
                                document.getElementById('foundDeviceName').innerText = data.deviceName || "Bilinmiyor";
                                document.getElementById('foundDeviceMac').innerText = data.mac;

                                // Nickname ayarla - kayıtlı araçta varsa onu göster, yoksa/yeni araçsa deviceName göster
                                const nicknameInput = document.getElementById('nicknameInput');
                                if (isPaired && existingDevice.nickname) {
                                    nicknameInput.value = existingDevice.nickname;
                                } else {
                                    nicknameInput.value = data.deviceName || "";
                                }

                                // Buton click eventini ayarla
                                pairButton.onclick = () => {
                                    const payload = {
                                        action: isPaired ? "update_nickname" : "pair_new_device",
                                        mac: data.mac,
                                        vehicleName: data.deviceName,
                                        nickname: nicknameInput.value
                                    };
                                    writeToDeviceMgmtChar(payload);

                                    const actionText = isPaired ? "Güncelleme" : "Eşleştirme";
                                    showToast(`${actionText} süreci başlatıldı...`, "info");
                                    closeModal();
                                };

                                ui.foundDeviceModal.style.display = 'flex';
                            })
                            .catch(error => {
                                console.error("Cihaz listesi okunamadı:", error);
                                showToast("Cihaz durumu kontrol edilemedi", "error");
                            });
                        break;

                    case 'scan_failed':
                        // Tarama başarısız oldu olayı
                        showToast("Tarama zaman aşımına uğradı, yeni cihaz bulunamadı.", "error");
                        break;

                    case 'pairing_complete':

                        document.body.classList.remove('scanning');
                        ui.scanButton.innerText = "Yakındaki Araçları Tara";
                        ui.scanButton.disabled = false;

                        // Eşleşme tamamlandı olayı (gelecekteki kullanım için)
                        showToast("Yeni cihaz başarıyla eşleştirildi!", "success");
                        setTimeout(renderDeviceList, 1000); // Listeyi 1 saniye sonra yenile
                        break;

                    // Buraya gelecekte başka event'ler eklenebilir
                }
            }
        }


        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
        }

        function showTab(tabId, clickedButton) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                const btnId = `tabBtn${tabId.replace('Screen', '')}`;
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.add('active');
            }
        }

        async function connectToDevice() {
            try {
                showToast("Cihaz aranıyor...");
                bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [GATE_SERVICE_UUID] }] });
                showToast("Cihaza bağlanılıyor...");
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(GATE_SERVICE_UUID);
                settingsCharacteristic = await service.getCharacteristic(CHAR_SETTINGS_UUID);
                pinAuthCharacteristic = await service.getCharacteristic(CHAR_PIN_AUTH_UUID);
                deviceMgmtCharacteristic = await service.getCharacteristic(CHAR_DEVICE_MGMT_UUID);

                // 1. Durum (Status) Karakteristiğine Eriş
                statusCharacteristic = await service.getCharacteristic(CHAR_STATUS_UUID);

                // 2. Bu karakteristikten gelecek bildirimleri dinlemeye başla
                await statusCharacteristic.startNotifications();
                statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusNotifications);


                ui.deviceNameDisplay.innerText = bleDevice.name || 'GATE';
                ui.deviceNameDisplay.style.display = 'block';

                await checkPinRequirement();
            } catch (error) {
                console.error("Bağlantı hatası:", error);
                showToast("Bağlantı kurulamadı.", "error");
            }
        }

        async function checkPinRequirement() {
            try {
                const value = await pinAuthCharacteristic.readValue();
                const response = JSON.parse(new TextDecoder().decode(value));
                if (response.pinRequired) {
                    showScreen('pinScreen');
                } else {
                    showToast("PIN gerekli değil, ana ekrana geçiliyor...", "success");
                    await showMainContentAndLoadData();
                }
            } catch (error) { showToast("PIN durumu okunamadı.", "error"); }
        }

        async function submitPin() {
            const pin = ui.pinInput.value;
            if (pin.length !== 4) { showToast("PIN 4 haneli olmalı."); return; }
            try {
                await pinAuthCharacteristic.writeValue(new TextEncoder().encode(pin));
                showToast("PIN gönderildi, ayarlar okunuyor...");
                await showMainContentAndLoadData();
            } catch (error) { showToast("PIN gönderilemedi veya yanlış.", "error"); }
        }


        function startVehicleScan() {
            // Eğer zaten tarama yapılıyorsa, tekrar başlatma
            if (document.body.classList.contains('scanning')) return;

            // Animasyonu başlatmak için body'e class ekle
            document.body.classList.add('scanning');

            // Tarama başladığında butonun metnini değiştir ve pasif yap
            ui.scanButton.innerText = "Taranıyor...";
            ui.scanButton.disabled = true;

            // İlerleme çubuğunu göster
            ui.scanProgressContainer.style.display = 'block';

            showToast("Yakındaki araçlar 10 saniye boyunca taranıyor...", "info");

            // BU NOKTADA, GATE'E TARAMAYI BAŞLATMASI İÇİN BLE KOMUTU GÖNDERİLİR
            const payload = { action: "start_discovery_scan" };
            writeToDeviceMgmtChar(payload);

            // 10 saniye sonra animasyonu ve buton durumunu sıfırla
            scanTimeoutId = setTimeout(() => { // Zamanlayıcıyı bir ID'ye ata
                finishScanUI(false); // Zaman aşımında toast göster
                showToast("Tarama zaman aşımına uğradı, yeni cihaz bulunamadı.", "error"); //
            }, 10000);
        }

        function finishScanUI(suppressToast = false) { // suppressToast parametresi eklendi
            document.body.classList.remove('scanning');
            ui.scanButton.innerText = "Yakındaki Araçları Tara";
            ui.scanButton.disabled = false;
            ui.scanProgressContainer.style.display = 'none';
            
            // Eğer toast gösterilmemesi istenmiyorsa
            if (!suppressToast) { //
                showToast("Tarama tamamlandı.", "success"); //
            }

            // Zamanlayıcıyı temizle
            if (scanTimeoutId) { //
                clearTimeout(scanTimeoutId); //
                scanTimeoutId = null; //
            }
        }

        async function showMainContentAndLoadData() {
            showScreen('mainContent');
            showTab('deviceManagementScreen', document.getElementById('tabBtnDeviceMgmt'));
            await renderDeviceList();
            await readGateSettings();
        }

        // --- Data Handling Functions ---

        async function renderDeviceList() {
            if (!deviceMgmtCharacteristic) return;
            try {
                const value = await deviceMgmtCharacteristic.readValue();
                const devices = JSON.parse(new TextDecoder().decode(value));
                ui.deviceList.innerHTML = '';

                if (devices.length === 0) {
                    ui.deviceList.innerHTML = '<p style="text-align:center; color:#888;">Kayıtlı araç bulunmuyor.</p>';
                    return;
                }

                devices.forEach(device => {
                    const item = document.createElement('div');
                    item.className = 'device-item';
                    // Cihazın kendi adını da (varsa) gösteriyoruz.
                    const vehicleNameDisplay = device.vehicleName ? `<strong class="vehicle-name">${device.vehicleName}</strong>` : '';

                    item.innerHTML = `
            <div class="device-info">
                <input type="text" value="${device.nickname}" id="nick-${device.mac}" placeholder="Takma İsim">
                <div class="device-details">
                    ${vehicleNameDisplay}
                    <span class="mac-address">${device.mac}</span>
                </div>
            </div>
            <div class="device-actions">
                <button onclick="updateNickname('${device.mac}')">Güncelle</button>
                <button class="btn-delete" onclick="deleteDevice('${device.mac}')">Sil</button>
            </div>
        `;
                    ui.deviceList.appendChild(item);
                });
            } catch (error) {
                console.error("Cihaz listesi okunamadı:", error);
                showToast("Cihaz listesi okunamadı. PIN yanlış olabilir.", "error");
                showScreen('pinScreen');
            }
        }

        async function updateNickname(mac) {
            const nickname = document.getElementById(`nick-${mac}`).value;
            const payload = { action: "update_nickname", mac: mac, nickname: nickname };
            await writeToDeviceMgmtChar(payload);
        }

        async function deleteDevice(mac) {
            if (confirm(`MAC Adresi: ${mac}\n\nBu aracı kalıcı olarak silmek istediğinizden emin misiniz?`)) {
                const payload = { action: "delete_device", mac: mac };
                await writeToDeviceMgmtChar(payload);
            }
        }

        async function writeToDeviceMgmtChar(payload) {
            try {
                await deviceMgmtCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(payload)));
                showToast("Komut gönderildi...", "success");
                setTimeout(renderDeviceList, 750);
            } catch (error) {
                console.error("Komut gönderilemedi:", error);
                showToast("Komut gönderilemedi.", "error");
            }
        }

        async function readGateSettings() {
            try {
                const value = await settingsCharacteristic.readValue();
                const settings = JSON.parse(new TextDecoder().decode(value));
                if (settings.error) {
                    showToast("Yetki gerekli: " + settings.error, "error");
                    showScreen('pinScreen');
                    return;
                }
                ui.gateDeviceNameInput.value = settings.deviceName || '';
                ui.closeTimeoutSlider.value = settings.closeTimeout || 30;
                ui.closeTimeoutValue.innerText = settings.closeTimeout || 30;
                ui.preCloseWarningSlider.value = settings.preCloseWarning || 5;
                ui.preCloseWarningValue.innerText = settings.preCloseWarning || 5;
                ui.operationModeSelect.value = settings.opMode || 0;
                ui.authRequiredCheckbox.checked = settings.authReq !== false;

                // Ayarlar okunduktan sonra uyarının ilk durumunu ayarla
                updateSecurityWarning(); // <<< YENİ SATIR

                deviceHasPin = settings.pinExists; // Cihazda PIN olup olmadığını kaydet


                if (settings.pinExists) {
                    ui.newPinInput.value = "****"; // Mevcut PIN'i gösterme, sadece maskele
                    ui.newPinInput.placeholder = "Değiştirmek için yeni PIN girin";
                    document.getElementById('pinRemoveHint').textContent = "(Kaldırmak için boş bırakın)";

                    ui.pinStatus.innerText = "Cihaz PIN ile korunuyor.";
                    ui.pinStatus.style.color = "#007AFF";
                } else {
                    ui.newPinInput.value = "";
                    ui.newPinInput.placeholder = "Yeni PIN (4 hane)";
                    document.getElementById('pinRemoveHint').textContent = "";

                    ui.pinStatus.innerText = "⚠️ PIN ayarlı değil! Herkes ayarlara erişebilir.";
                    ui.pinStatus.style.color = "#D32F2F"; // Dikkat çekici kırmızı renk
                }
                isPinInputModified = false; // Bayrağı sıfırla

            } catch (error) {
                console.error("Gate ayarları okunurken hata:", error);
                showToast("Gate ayarları okunamadı. PIN yanlış olabilir.", "error");
                showScreen('pinScreen');
            }
        }

        // <script> etiketi içinde -> writeGateSettings fonksiyonunu bununla değiştirin
        async function writeGateSettings() {
            try {
                const payload = {
                    deviceName: ui.gateDeviceNameInput.value,
                    closeTimeout: parseInt(ui.closeTimeoutSlider.value, 10),
                    preCloseWarning: parseInt(ui.preCloseWarningSlider.value, 10),
                    opMode: parseInt(ui.operationModeSelect.value, 10),
                    authReq: ui.authRequiredCheckbox.checked
                };

                // --- YENİ VE SADELEŞTİRİLMİŞ PIN YÖNETİM MANTIĞI ---

                // Sadece ve sadece kullanıcı PIN metin kutusuna dokunup onu değiştirdiyse
                // PIN ile ilgili bir işlem yap.
                if (isPinInputModified) {
                    const newPin = ui.newPinInput.value;

                    // Durum 1: Kullanıcı kutuyu boş bıraktı (PIN'i silmek istiyor)
                    if (newPin.length === 0) {
                        // Sadece cihazda gerçekten silinecek bir PIN varsa onay iste
                        if (deviceHasPin) {
                            if (confirm("Mevcut PIN'i kalıcı olarak silmek istediğinizden emin misiniz?")) {
                                payload.pinCode = ""; // Silme komutunu payload'a ekle
                            } else {
                                readGateSettings(); // Kullanıcı vazgeçti, arayüzü eski haline getir
                                return; // Tüm işlemi durdur
                            }
                        }
                        // Zaten PIN yoksa ve kutu boşsa hiçbir şey yapmaya gerek yok.
                    }
                    // Durum 2: Kullanıcı yeni bir PIN girdi
                    else {
                        // Yeni PIN'in 4 haneli bir sayı olup olmadığını kontrol et
                        if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                            showToast("Yeni PIN 4 haneli bir sayı olmalıdır!", "error");
                            return; // Geçersizse işlemi durdur
                        }
                        payload.pinCode = newPin; // Yeni PIN'i payload'a ekle
                    }
                }
                // Eğer kullanıcı PIN kutusuna hiç dokunmadıysa (isPinInputModified == false ise),
                // payload'a pinCode alanı hiç eklenmez ve mevcut PIN güvende kalır.

                // Ayarları cihaza gönder
                await settingsCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(payload)));

                showToast("Ayarlar cihaza gönderiliyor...", "info");

                // İşlem sonrası arayüzü ve bayrakları temizle
                ui.newPinInput.value = '';
                isPinInputModified = false;

                // Cihazdaki ayarların son halini okuyarak arayüzü yenile
                setTimeout(readGateSettings, 1500);

            } catch (error) {
                console.error("Gate ayarları kaydedilemedi:", error);
                showToast("Ayarlar kaydedilemedi.", "error");
            }
        }

        // --- UI/Helper Functions ---
        function onDisconnected() {
            showToast("Cihaz bağlantısı koptu.", "error");
            showScreen('connectScreen');
            ui.deviceNameDisplay.style.display = 'none';
        }

        async function disconnectFromDevice() {
            if (bleDevice && bleDevice.gatt.connected) {
                await bleDevice.gatt.disconnect();
            }
        }

        function updateSecurityWarning() {
            if (ui.authRequiredCheckbox.checked) {
                ui.securityWarning.style.display = 'none';
            } else {
                ui.securityWarning.style.display = 'block';
            }
        }

        function showToast(message, type = "info") {
            const toast = ui.toast;
            toast.textContent = message;
            toast.style.display = 'block';
            toast.style.backgroundColor = type === "success" ? '#4CAF50' : (type === "error" ? '#f44336' : 'rgba(0,0,0,0.75)');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
    </script>
</body>

</html>