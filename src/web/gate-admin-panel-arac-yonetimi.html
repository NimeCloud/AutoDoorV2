<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Kontrol Paneli</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column; background-color: #f0f2f5; }
        .container { background: white; padding: 25px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        .screen { display: none; width: 100%; }
        #connectScreen { display: block; }
        button, select { width: 100%; padding: 15px; background-color: #007AFF; color: white; border: none; cursor: pointer; font-size: 18px; font-weight: 500; border-radius: 10px; transition: background-color 0.3s ease; margin-bottom: 10px; }
        button:hover, select:hover { background-color: #005ecb; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab-button { flex: 1; padding: 15px; background: none; border: none; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .tab-button.active { color: #007AFF; border-bottom-color: #007AFF; font-weight: 600; }
        .tab-content { display: none; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 16px; color: #333; }
        .input-group input, .input-group select { box-sizing: border-box; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .device-name-display { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #1c1c1e; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.75); color: white; padding: 12px 24px; border-radius: 8px; z-index: 1000; display: none; }
        .device-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; gap: 10px; }
        .device-info { flex-grow: 1; text-align: left; }
        .device-info input { border: 1px solid #ccc; padding: 8px; border-radius: 6px; font-size: 14px; width: 150px; }
        .device-actions button { font-size: 12px; padding: 6px 12px; width: auto; margin-left: 5px; border-radius: 6px; }
        .btn-delete { background-color: #f44336 !important; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="deviceNameDisplay" style="display: none;">Gate Kontrol Paneli</h2>
        
        <div id="connectScreen" class="screen">
            <button id="connectButton">Gate Cihazına Bağlan</button>
        </div>

        <div id="pinScreen" class="screen">
            <p>Ayarlara erişmek için lütfen PIN girin:</p>
            <div class="input-group">
                <label for="pinInput">PIN:</label>
                <input type="password" id="pinInput" maxlength="4" pattern="\d{4}" inputmode="numeric" />
            </div>
            <button id="submitPinButton">PIN'i Gönder</button>
        </div>

        <div id="mainContent" class="screen">
            <div class="tabs">
                <button id="tabBtnDeviceMgmt" class="tab-button" onclick="showTab('deviceManagementScreen', this)">Araç Yönetimi</button>
                <button id="tabBtnSettings" class="tab-button" onclick="showTab('settingsScreen', this)">Gate Ayarları</button>
            </div>

            <div id="deviceManagementScreen" class="tab-content">
                <h3>Eşleşmiş Araçlar</h3>
                <div id="deviceList"><i>Liste Yükleniyor...</i></div>
            </div>

            <div id="settingsScreen" class="tab-content">
                <h3>Gate Ayarları</h3>
                <p>Gate'in kendi ayarları (Otomatik Kapanma, Çalışma Modu vb.) bu sekmede yer alacak.</p>
            </div>
            
            <button id="disconnectButton" style="background-color:#6c757d; margin-top: 20px;">Bağlantıyı Kes</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <script>
    // UUIDs
    const GATE_SERVICE_UUID = "e3a1b2f0-5f4d-4c8a-bd2f-8e6a7f3b9c0d";
    const CHAR_SETTINGS_UUID = "a1d2f3e4-5678-4b9a-b3c2-9d8e7f6a5b4c";
    const CHAR_PIN_AUTH_UUID = "b2c3d4e5-6789-4f0b-c1d2-a3b4c5d6e7f8";
    const CHAR_DEVICE_MGMT_UUID = "d4e5f6a7-8901-4b2d-c3e4-f5a6b7c8d9e0";

    // Global variables
    let bleDevice, settingsCharacteristic, pinAuthCharacteristic, deviceMgmtCharacteristic;
    let toastTimeout;

    // --- Event Listeners and Connection Flow ---
    document.getElementById('connectButton').addEventListener('click', connectToDevice);
    document.getElementById('disconnectButton').addEventListener('click', disconnectFromDevice);
    document.getElementById('submitPinButton').addEventListener('click', submitPin);
    
    // --- Core Functions ---

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(screenId).style.display = 'block';
    }

    function showTab(tabId, clickedButton) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).style.display = 'block';
        if (clickedButton) {
            clickedButton.classList.add('active');
        } else { // Fallback if called without a button context
            document.getElementById(`tabBtn${tabId.replace('Screen', '')}`).classList.add('active');
        }
    }

    async function connectToDevice() {
        try {
            showToast("Cihaz aranıyor...");
            bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [GATE_SERVICE_UUID] }] });
            showToast("Cihaza bağlanılıyor...");
            bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
            const server = await bleDevice.gatt.connect();
            const service = await server.getPrimaryService(GATE_SERVICE_UUID);
            settingsCharacteristic = await service.getCharacteristic(CHAR_SETTINGS_UUID);
            pinAuthCharacteristic = await service.getCharacteristic(CHAR_PIN_AUTH_UUID);
            deviceMgmtCharacteristic = await service.getCharacteristic(CHAR_DEVICE_MGMT_UUID);
            
            document.getElementById('deviceNameDisplay').style.display = 'block';
            document.getElementById('deviceNameDisplay').innerText = bleDevice.name || 'GATE';
            
            await checkPinRequirement();
        } catch (error) {
            console.error("Bağlantı hatası:", error);
            showToast("Bağlantı kurulamadı.", "error");
        }
    }

    async function checkPinRequirement() {
        try {
            const value = await pinAuthCharacteristic.readValue();
            const response = JSON.parse(new TextDecoder().decode(value));
            if (response.pinRequired) {
                showScreen('pinScreen');
            } else {
                showToast("PIN gerekli değil, ana ekrana geçiliyor...", "success");
                await showMainContentAndLoadData();
            }
        } catch(error) { showToast("PIN durumu okunamadı.", "error"); }
    }
    
    async function submitPin() {
        const pin = document.getElementById('pinInput').value;
        if (pin.length !== 4) { showToast("PIN 4 haneli olmalı."); return; }
        try {
            await pinAuthCharacteristic.writeValue(new TextEncoder().encode(pin));
            showToast("PIN gönderildi, ayarlar okunuyor...");
            await showMainContentAndLoadData();
        } catch(error) { showToast("PIN gönderilemedi veya yanlış.", "error"); }
    }

    async function showMainContentAndLoadData() {
        showScreen('mainContent');
        showTab('deviceManagementScreen', document.getElementById('tabBtnDeviceMgmt'));
        await renderDeviceList();
        // Gelecekte gate ayarları sekmesi için okuma fonksiyonu da buraya eklenecek
    }

    // --- Data Handling Functions ---

    async function renderDeviceList() {
        if (!deviceMgmtCharacteristic) return;
        try {
            const value = await deviceMgmtCharacteristic.readValue();
            const devices = JSON.parse(new TextDecoder().decode(value));
            const listContainer = document.getElementById('deviceList');
            listContainer.innerHTML = ''; 

            if (devices.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:#888;">Kayıtlı araç bulunmuyor.</p>';
                return;
            }

            devices.forEach(device => {
                const item = document.createElement('div');
                item.className = 'device-item';
                item.innerHTML = `
                    <div class="device-info">
                        <input type="text" value="${device.nickname}" id="nick-${device.mac}" placeholder="Takma İsim">
                        <small style="color: #666;">${device.mac}</small>
                    </div>
                    <div class="device-actions">
                        <button onclick="updateNickname('${device.mac}')">Güncelle</button>
                        <button class="btn-delete" onclick="deleteDevice('${device.mac}')">Sil</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        } catch (error) { 
            console.error("Cihaz listesi okunamadı:", error); 
            showToast("Cihaz listesi okunamadı. PIN yanlış olabilir.", "error");
            showScreen('pinScreen'); // Yetki hatasıysa PIN ekranına geri dön
        }
    }

    async function updateNickname(mac) {
        const nickname = document.getElementById(`nick-${mac}`).value;
        const payload = { action: "update_nickname", mac: mac, nickname: nickname };
        await writeToDeviceMgmtChar(payload);
    }

    async function deleteDevice(mac) {
        if (confirm(`MAC Adresi: ${mac}\n\nBu aracı kalıcı olarak silmek istediğinizden emin misiniz?`)) {
            const payload = { action: "delete_device", mac: mac };
            await writeToDeviceMgmtChar(payload);
        }
    }
    
    async function writeToDeviceMgmtChar(payload) {
         try {
            await deviceMgmtCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(payload)));
            showToast("Komut gönderildi...", "success");
            setTimeout(renderDeviceList, 750); 
         } catch(error) { 
             console.error("Komut gönderilemedi:", error);
             showToast("Komut gönderilemedi.", "error");
         }
    }
    
    // --- UI/Helper Functions ---

    function onDisconnected() {
        showToast("Cihaz bağlantısı koptu.", "error");
        showScreen('connectScreen');
        document.getElementById('deviceNameDisplay').style.display = 'none';
    }

    async function disconnectFromDevice() {
        if (bleDevice && bleDevice.gatt.connected) {
            await bleDevice.gatt.disconnect();
        }
    }
    
    function showToast(message, type = "info") {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display='block';
        toast.style.backgroundColor = type === "success" ? '#4CAF50' : (type === "error" ? '#f44336' : 'rgba(0,0,0,0.75)');
        if(toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(()=>t.style.display='none', 3000);
    }
    </script>
</body>
</html>