<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Araç Ünitesi Kontrol Paneli</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column; background-color: #f0f2f5; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; }
        .screen { display: none; width: 100%; }
        #connectScreen { display: block; }
        button { padding: 15px; background-color: #007AFF; color: white; border: none; cursor: pointer; font-size: 18px; font-weight: 500; border-radius: 10px; transition: background-color 0.3s ease; width: 100%; margin-bottom: 10px; }
        button:hover { background-color: #005ecb; }
        .slider-wrapper { margin: 20px 0; }
        .slider-wrapper label { width: 100%; text-align: left; font-size: 16px; color: #333; margin-bottom: 10px; display: block; }
        .slider-wrapper .value { font-weight: bold; color: #007AFF; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); display: none; z-index: 1000; font-size: 14px; }
        .device-name-display { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #1c1c1e; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 16px; color: #333; }
        .input-group input { box-sizing: border-box; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .pin-status-text { font-size: 12px; margin-top: 5px; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="deviceNameDisplay" style="display: none;">Araç Ünitesi</h2>

        <div id="connectScreen" class="screen">
            <button id="connectButton">Cihaza Bağlan</button>
        </div>

        <div id="pinScreen" class="screen">
            <p>Ayarlara erişmek için lütfen PIN girin:</p>
            <div class="input-group">
                <label for="pinInput">PIN:</label>
                <input type="password" id="pinInput" maxlength="4" pattern="\d{4}" inputmode="numeric" />
            </div>
            <button id="submitPinButton">PIN'i Gönder</button>
        </div>

        <div id="settingsScreen" class="screen">
            <div class="input-group">
                <label for="deviceNameInput">Cihaz Adı:</label>
                <input type="text" id="deviceNameInput" />
            </div>
            <div class="slider-wrapper">
                <label for="warningSlider">Uyarı Süresi: <span id="warningValue">10</span> saniye</label>
                <input type="range" id="warningSlider" class="slider" min="1" max="30" value="10" />
            </div>
            <div class="input-group">
                <label for="newPinInput">PIN'i Değiştir/Sıfırla (Dokunmayacaksanız boş bırakın)</label>
                <input type="text" id="newPinInput" maxlength="4" pattern="\d{0,4}" inputmode="numeric" placeholder="Değiştirmek için yeni PIN girin" />
                <span id="pinStatus" class="pin-status-text"></span>
            </div>
            <button id="saveSettingsButton">Ayarları Kaydet</button>
            <button id="disconnectButton" style="background-color: #607d8b;">Bağlantıyı Kes</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
    // UUIDs
    const VEHICLE_SERVICE_UUID = "b1c2d3e4-5f4d-4c8a-bd2f-8e6a7f3b9c0d";
    const CHAR_SETTINGS_UUID = "a1d2f3e4-5678-4b9a-b3c2-9d8e7f6a5b4c";
    const CHAR_PIN_AUTH_UUID = "b2c3d4e5-6789-4f0b-c1d2-a3b4c5d6e7f8";
    const CHAR_STATUS_UUID   = "c3d4e5f6-7890-4a1c-b2d3-e4f5a6b7c8d9";

    // Global Variables
    let bleDevice, settingsCharacteristic, pinAuthCharacteristic, statusCharacteristic;
    let toastTimeout, isPinInputModified = false, deviceHasPin = false;

    // UI Elements
    const ui = {
        connectButton: document.getElementById('connectButton'),
        disconnectButton: document.getElementById('disconnectButton'),
        submitPinButton: document.getElementById('submitPinButton'),
        saveSettingsButton: document.getElementById('saveSettingsButton'),
        connectScreen: document.getElementById('connectScreen'),
        pinScreen: document.getElementById('pinScreen'),
        settingsScreen: document.getElementById('settingsScreen'),
        deviceNameDisplay: document.getElementById('deviceNameDisplay'),
        deviceNameInput: document.getElementById('deviceNameInput'),
        warningSlider: document.getElementById('warningSlider'),
        warningValueElement: document.getElementById('warningValue'),
        pinInput: document.getElementById('pinInput'),
        newPinInput: document.getElementById('newPinInput'),
        pinStatus: document.getElementById('pinStatus'),
        toast: document.getElementById('toast')
    };

    // Event Listeners
    ui.connectButton.addEventListener('click', connectToDevice);
    ui.disconnectButton.addEventListener('click', disconnectFromDevice);
    ui.submitPinButton.addEventListener('click', submitPin);
    ui.saveSettingsButton.addEventListener('click', writeSettingsToDevice);
    ui.warningSlider.addEventListener('input', (e) => ui.warningValueElement.innerText = e.target.value);
    ui.newPinInput.addEventListener('input', () => isPinInputModified = true);

    // --- Core Functions ---

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(screenId).style.display = 'block';
    }

    async function connectToDevice() {
        try {
            showToast("Cihaz aranıyor...");
            bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [VEHICLE_SERVICE_UUID] }] });
            showToast("Cihaza bağlanılıyor...");
            bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
            const server = await bleDevice.gatt.connect();
            const service = await server.getPrimaryService(VEHICLE_SERVICE_UUID);
            settingsCharacteristic = await service.getCharacteristic(CHAR_SETTINGS_UUID);
            pinAuthCharacteristic = await service.getCharacteristic(CHAR_PIN_AUTH_UUID);
            statusCharacteristic = await service.getCharacteristic(CHAR_STATUS_UUID);

            await statusCharacteristic.startNotifications();
            statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusNotifications);
            
            ui.deviceNameDisplay.innerText = bleDevice.name || 'ARAÇ';
            ui.deviceNameDisplay.style.display = 'block';
            await checkPinRequirement();
        } catch (error) {
            console.error("Bağlantı hatası:", error);
            showToast("Bağlantı kurulamadı.", "error");
        }
    }

    function onDisconnected() {
        showToast("Cihaz bağlantısı koptu.", "error");
        showScreen('connectScreen');
        ui.deviceNameDisplay.style.display = 'none';
    }

    async function disconnectFromDevice() {
        if (bleDevice && bleDevice.gatt.connected) await bleDevice.gatt.disconnect();
    }
    
    async function checkPinRequirement() {
        try {
            const value = await pinAuthCharacteristic.readValue();
            const response = JSON.parse(new TextDecoder().decode(value));
            if (response.pinRequired) {
                showScreen('pinScreen');
            } else {
                showToast("PIN gerekli değil, ayarlar okunuyor...", "success");
                await showSettingsAndRead();
            }
        } catch(error) { showToast("PIN durumu okunamadı.", "error"); }
    }
    
    async function submitPin() {
        const pin = ui.pinInput.value;
        if (pin.length !== 4) { showToast("PIN 4 haneli olmalı.", "error"); return; }
        try {
            await pinAuthCharacteristic.writeValue(new TextEncoder().encode(pin));
            showToast("PIN gönderildi, cihazdan onay bekleniyor...");
        } catch(error) { showToast("PIN gönderilemedi.", "error"); }
    }
    
    function handleStatusNotifications(event) {
        const statusMsg = new TextDecoder().decode(event.target.value);
        if (statusMsg === "AUTH_SUCCESS") showSettingsAndRead();
        else if (statusMsg === "AUTH_FAILED") showToast("Yanlış PIN!", "error");
        else if (statusMsg === "SETTINGS_UPDATED") {
            showToast("Ayarlar başarıyla kaydedildi.", "success");
            setTimeout(readCurrentSettings, 750);
        }
    }

    async function showSettingsAndRead() {
        showScreen('settingsScreen');
        await readCurrentSettings();
    }

    async function readCurrentSettings() {
        try {
            const value = await settingsCharacteristic.readValue();
            const settings = JSON.parse(new TextDecoder().decode(value));
            if(settings.error) {
                showToast("Yetki gerekli: " + settings.error, "error");
                showScreen('pinScreen');
                return;
            }
            
            ui.warningSlider.value = (settings.warnDuration || 10000) / 1000;
            ui.warningValueElement.innerText = ui.warningSlider.value;
            ui.deviceNameInput.value = settings.deviceName || '';
            ui.deviceNameDisplay.innerText = settings.deviceName || 'ARAÇ';
            
            deviceHasPin = settings.pinExists;

            if (settings.pinExists) {
                ui.newPinInput.value = "****";
                ui.newPinInput.placeholder = "Değiştirmek için yeni PIN girin";
                ui.pinStatus.innerText = "Cihaz PIN ile korunuyor.";
            } else {
                ui.newPinInput.value = "";
                ui.newPinInput.placeholder = "Yeni bir PIN belirleyin (4 hane)";
                ui.pinStatus.innerText = "Cihazda PIN ayarlı değil.";
            }
            isPinInputModified = false;
        } catch (error) {
            console.error("Ayarlar okunurken hata:", error);
            showToast("Ayarlar okunamadı. PIN yanlış olabilir.", "error");
            showScreen('pinScreen');
        }
    }

    async function writeSettingsToDevice() {
        try {
            const payload = {
                warnDuration: parseInt(ui.warningSlider.value, 10) * 1000,
                deviceName: ui.deviceNameInput.value
            };

            if (isPinInputModified) {
                const newPin = ui.newPinInput.value;
                if (newPin.length === 0) {
                    if (deviceHasPin && confirm("Mevcut PIN'i kalıcı olarak silmek istediğinizden emin misiniz?")) {
                        payload.pinCode = "";
                    } else if (!deviceHasPin) {
                        // Zaten PIN yok, bir şey yapma
                    } else {
                        readCurrentSettings(); return;
                    }
                } else {
                    if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                        showToast("Yeni PIN 4 haneli bir sayı olmalıdır!", "error");
                        return;
                    }
                    payload.pinCode = newPin;
                }
            }
            
            await settingsCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(payload)));
            showToast("Ayarlar cihaza gönderiliyor...", "info");
            
            ui.newPinInput.value = '';
            isPinInputModified = false;
        } catch (error) {
            console.error("Ayarlar kaydedilemedi:", error);
            showToast("Ayarlar kaydedilemedi!", "error");
        }
    }

    function showToast(message, type = "info") {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        toast.style.backgroundColor = type === "success" ? '#4CAF50' : (type === "error" ? '#f44336' : 'rgba(0,0,0,0.75)');
        if(toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
    </script>
</body>
</html>