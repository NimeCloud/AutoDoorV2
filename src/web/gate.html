<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Kontrol Paneli</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            background-color: #f0f2f5;
        }

        .container {
            background: white;
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .screen {
            display: none;
            width: 100%;
        }

        #connectScreen {
            display: block;
        }

        button,
        select {
            width: 100%;
            padding: 15px;
            background-color: #007AFF;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            border-radius: 10px;
            transition: background-color 0.3s ease;
            margin-bottom: 10px;
        }

        button:disabled {
            background-color: #a0cffc;
            cursor: not-allowed;
        }

        button:hover,
        select:hover {
            background-color: #005ecb;
            /* DiÄŸer panel ile tutarlÄ± mavi tonu */
        }

        button.btn-secondary {
            background-color: #5a6268;
        }

        button.btn-secondary:hover {
            background-color: #4a4f54;
        }

        button.btn-success {
            background-color: #28a745;
        }

        button.btn-success:hover {
            background-color: #218838;
        }

        .btn-delete {
            background-color: #D32F2F !important;
            /* Koyu, dikkat Ã§ekici kÄ±rmÄ±zÄ± */
        }

        .btn-delete:hover {
            background-color: #B71C1C !important;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            color: #8e8e93;


        }

        .tab-button.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #333;
        }

        .input-group input,
        .input-group select {
            box-sizing: border-box;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        /* Slider'larÄ±n rengini ana mavi temasÄ±na uygun hale getir */
        input[type="range"] {
            accent-color: #007AFF;
            /* KaydÄ±rma yuvarlaÄŸÄ±nÄ±n rengini ayarlar */
        }

        /* Checkbox'larÄ±n rengini ana mavi temasÄ±na uygun hale getir */
        input[type="checkbox"] {
            accent-color: #007AFF;
            /* Checkbox iÅŸaretinin rengini ayarlar */
            width: auto;
            vertical-align: middle;
        }

        #otaProgressBar {

            min-width: 40px;


            background-color: #4CAF50;
            color: white;

            line-height: 20px;
            /* veya progress bar'Ä±nÄ±zÄ±n yÃ¼ksekliÄŸi neyse */
            width: 0%;
            border-radius: 5px;
            font-size: small;
            padding-left: 5px;
            /* Ä°htiyacÄ±nÄ±za gÃ¶re bu deÄŸeri ayarlayabilirsiniz */
        }

        #otaUpdateContainer .progress-container {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        #otaUpdateContainer .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #007AFF;
            border-radius: 10px;
            transition: width 0.2s linear;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
        }

        .slider-wrapper .value {
            font-weight: bold;
            color: #007AFF;
        }

        .device-name-display {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1c1c1e;
        }

        hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 25px 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 15px;
            /* Takma ad kutusu ile diÄŸer bilgiler arasÄ±na boÅŸluk koy */
            flex-grow: 1;
            /* MÃ¼mkÃ¼n olan tÃ¼m alanÄ± kapla */
            text-align: left;
        }

        .device-info input {
            width: 180px;
            /* GeniÅŸliÄŸi artÄ±rdÄ±k */
            flex-shrink: 0;
            padding: 8px;
            /* Dikey boÅŸluÄŸu artÄ±rarak daha dengeli hale getirdik */
            font-size: 15px;
            /* YazÄ± tipini biraz bÃ¼yÃ¼ttÃ¼k */
        }

        .device-details {
            display: flex;
            flex-direction: column;
            /* Cihaz adÄ± ve MAC adresini alt alta sÄ±rala */
            line-height: 1.3;
        }

        .vehicle-name {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }

        .mac-address {
            font-size: 12px;
            color: #888;
        }

        .device-actions {
            flex-shrink: 0;
            /* ButonlarÄ±n da kÃ¼Ã§Ã¼lmesini engelle */
        }

        .device-actions button {
            font-size: 11px;
            /* YazÄ± tipini kÃ¼Ã§Ã¼lttÃ¼k */
            font-weight: 500;
            /* YazÄ±yÄ± biraz incelttik */
            padding: 6px 10px;
            /* Ä°Ã§ boÅŸluÄŸu azalttÄ±k */
            width: auto;
            margin-left: 5px;
            border-radius: 5px;
            /* KÃ¶ÅŸeleri daha az yuvarlak yaptÄ±k */
            margin-bottom: 0;
            /* Alt boÅŸluÄŸu kaldÄ±rdÄ±k */
        }

        .btn-delete {
            background-color: #f44336 !important;
        }

        .warning-text {
            display: none;
            /* VarsayÄ±lan olarak gizli */
            color: #D32F2F;
            /* Koyu kÄ±rmÄ±zÄ± renk */
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            padding: 10px;
            background-color: #FFEBEE;
            /* Ã‡ok aÃ§Ä±k kÄ±rmÄ±zÄ± arka plan */
            border-radius: 6px;
            text-align: left;
        }


        .scan-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-scan {
            flex-shrink: 0;
            /* Butonun boyutu sabit kalsÄ±n */
            width: auto;
            padding: 10px 15px;
            font-size: 14px;
            background-color: #28a745 !important;
            /* YeÅŸil renk */
            margin-bottom: 0;
        }

        .btn-scan:hover {
            background-color: #218838 !important;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            display: none;
            /* VarsayÄ±lan olarak gizli */
        }

        .progress-bar {
            height: 100%;
            width: 100%;
            background-color: #007AFF;
            border-radius: 5px;
            transition: width 0.5s ease-out;
            /* GeniÅŸlik deÄŸiÅŸimini yumuÅŸat */
        }

        /* JavaScript ile bu class eklendiÄŸinde animasyon baÅŸlayacak */
        .scanning .progress-container {
            display: block !important;
        }

        .scanning .progress-bar {
            animation: scanProgressAnimation 10s linear forwards;
            display: block !important;

        }

        @keyframes scanProgressAnimation {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }




        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 450px;
            border-radius: 10px;
            text-align: left;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }


        /* <style> etiketinin iÃ§ine, mevcut kurallarÄ±n sonuna ekleyebilirsiniz */

        /* Genel olarak TÃœM devre dÄ±ÅŸÄ± butonlar iÃ§in temel stil */
        /* Bu, normal mavi butonlarÄ±n ve diÄŸerlerinin gri gÃ¶rÃ¼nmesini saÄŸlar */
        button:disabled {
            background-color: #cccccc;
            /* Soluk gri */
            color: #666666;
            /* Koyu gri yazÄ± */
            cursor: not-allowed;
            /* "Ä°zin verilmiyor" imleci */
            opacity: 0.65;
            /* Butonu soluklaÅŸtÄ±rarak pasif olduÄŸunu belli eder */
        }

        /* Renkli butonlarÄ±n devre dÄ±ÅŸÄ± halleri iÃ§in Ã¶zel kurallar */
        /* Bu, kÄ±rmÄ±zÄ± butonun soluk kÄ±rmÄ±zÄ±, yeÅŸilin soluk yeÅŸil olmasÄ±nÄ± saÄŸlar */
        /* !important kullanarak diÄŸer stilleri ezdiÄŸinden emin oluruz */

        button.btn-delete:disabled {
            background-color: #f48fb1 !important;
            /* Soluk kÄ±rmÄ±zÄ± */
            opacity: 0.7;
        }

        button.btn-success:disabled {
            background-color: #a5d6a7 !important;
            /* Soluk yeÅŸil */
            opacity: 0.7;
        }

        /* Ä°kincil butonlar iÃ§in de bir kural ekleyelim */
        button.btn-secondary:disabled {
            background-color: #adb5bd !important;
            /* Soluk ikincil renk */
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <div class="container">

        <div id="foundDeviceModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal()">&times;</span>
                <h3 id="modalTitle">AraÃ§ Bulundu</h3>
                <div class="input-group">
                    <label>AraÃ§ AdÄ±:</label>
                    <p id="foundDeviceName" style="font-weight:bold;"></p>
                </div>
                <div class="input-group">
                    <label>MAC Adresi:</label>
                    <p id="foundDeviceMac"></p>
                </div>
                <div class="input-group">
                    <label for="nicknameInput">Bir Takma Ä°sim Belirleyin:</label>
                    <input type="text" id="nicknameInput" placeholder="Ã–rn: Mavi Araba">
                </div>
                <button id="pairButton">Onayla</button>
            </div>
        </div>

        <h2 id="deviceNameDisplay" style="display: none;">Gate Kontrol Paneli</h2>

        <div id="connectScreen" class="screen">
            <button id="connectButton">Gate CihazÄ±na BaÄŸlan</button>
        </div>

        <div id="pinScreen" class="screen">
            <p>Ayarlara eriÅŸmek iÃ§in lÃ¼tfen PIN girin:</p>
            <div class="input-group">
                <label for="pinInput">PIN:</label>
                <input type="password" id="pinInput" maxlength="4" pattern="\d{4}" inputmode="numeric" />
            </div>
            <button id="submitPinButton">PIN'i GÃ¶nder</button>
        </div>

        <div id="mainContent" class="screen">
            <div class="tabs">
                <button id="tabBtnDeviceMgmt" class="tab-button" onclick="showTab('deviceManagementScreen', this)">AraÃ§
                    YÃ¶netimi</button>
                <button id="tabBtnSettings" class="tab-button" onclick="showTab('settingsScreen', this)">Gate
                    AyarlarÄ±</button>
            </div>

            <div id="deviceManagementScreen" class="tab-content">
                <h3>EÅŸleÅŸmiÅŸ AraÃ§lar</h3>
                <div class="scan-container">
                    <button id="scanButton" class="btn-scan">YakÄ±ndaki AraÃ§larÄ± Tara</button>
                    <div id="scanProgressContainer" class="progress-container">
                        <div id="scanProgressBar" class="progress-bar"></div>
                    </div>
                </div>
                <div id="deviceList"><i>Liste YÃ¼kleniyor...</i></div>
            </div>

            <div id="settingsScreen" class="tab-content">


                <h3>Gate AyarlarÄ±</h3>
                <div class="input-group">
                    <label for="gateDeviceNameInput">Cihaz AdÄ±:</label>
                    <input type="text" id="gateDeviceNameInput" />
                </div>
                <div class="input-group">

                    <label for="newPinInput">PIN <span id="pinRemoveHint"
                            style="font-size:12px; color:#888;"></span></label>
                    <input type="text" id="newPinInput" maxlength="4" pattern="\d{0,4}" inputmode="numeric"
                        placeholder="Yeni PIN (4 hane)" />
                    <span id="pinStatus" style="font-size: 12px; margin-top: 5px; display: block;"></span>
                </div>


                <div class="input-group">
                    <label for="operationModeSelect">Ã‡alÄ±ÅŸma Modu:</label>
                    <select id="operationModeSelect">
                        <option value="0">Normal (Otomatik)</option>
                        <option value="1">SÃ¼rekli AÃ§Ä±k Tut</option>
                        <option value="2">SÃ¼rekli KapalÄ± Tut</option>
                        <option value="3">Servis DÄ±ÅŸÄ±</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="authRequiredCheckbox" style="width:auto; vertical-align: middle;">
                        YÃ¼ksek GÃ¼venlik Modu (Ã–nerilir)
                    </label>
                    <span id="securityWarning" class="warning-text">
                        âš ï¸ GÃ¼venlik devre dÄ±ÅŸÄ±! Bu modda herhangi bir araÃ§ kapÄ±yÄ± Ã§alÄ±ÅŸtÄ±rabilir.
                    </span>
                </div>
                <div class="input-group">
                    <label>Oto. Kapanma SÃ¼resi (Sinyal KaybÄ±): <span id="closeTimeoutValue">30</span>s</label>
                    <input type="range" id="closeTimeoutSlider" min="10" max="600" step="5">
                </div>
                <div class="input-group">
                    <label>Kapanma Ã–ncesi UyarÄ± SÃ¼resi: <span id="preCloseWarningValue">5</span>s</label>
                    <input type="range" id="preCloseWarningSlider" min="1" max="15" step="1">
                </div>
                <button id="saveSettingsButton">AyarlarÄ± Kaydet</button>

                <hr>
                <h3>Firmware & GÃ¼ncelleme</h3>
                <div class="input-group">
                    <label>Mevcut Firmware Versiyonu:</label>
                    <p id="firmwareVersionDisplay" style="font-weight:bold;">Bilinmiyor</p>
                </div>
                <div class="input-group" style="display: none;">
                    <label for="updateUrlInput">Update URL:</label>
                    <input type="url" id="updateUrlInput"
                        value="https://raw.githubusercontent.com/NimeCloud/GateControlFirmware/main/version.json">
                </div>

                <div id="otaUpdateContainer">
                    <button id="checkUpdateButton" class="btn-secondary">GÃ¼ncellemeleri Kontrol Et</button>
                    <button id="startUpdateButton" class="btn-success" style="display:none;">Yeni Versiyonu Ä°ndir ve
                        YÃ¼kle</button>
                    <div class="progress-container" style="display: none;">
                        <div id="otaProgressBar" class="progress-bar">0%</div>
                    </div>
                </div>

            </div>


            <button id="rebootDeviceButton" class="btn-secondary" style="margin-top: 20px;">CihazÄ± Yeniden
                BaÅŸlat</button>
            <button id="disconnectButton" style="background-color:#6c757d; margin-top: 10px;">BaÄŸlantÄ±yÄ± Kes</button>

        </div>
    </div>
    <div id="toast" class="toast"></div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <h3 id="successModalTitle">Ä°ÅŸlem BaÅŸarÄ±lÄ±!</h3>
            <p id="successModalMessage">Firmware gÃ¼ncellemesi baÅŸarÄ±yla tamamlandÄ±.</p>
            <button id="rebootDeviceButton">CihazÄ± Yeniden BaÅŸlat</button>
        </div>
    </div>

    <div id="updateConfirmModal" class="modal">
        <div class="modal-content">
            <h3 id="updateConfirmModalTitle">Yeni GÃ¼ncelleme Bulundu!</h3>
            <p id="updateConfirmModalMessage">CihazÄ±nÄ±z iÃ§in yeni bir firmware versiyonu mevcut. Åimdi yÃ¼klemek ister
                misiniz?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="cancelUpdateButton" class="btn-secondary" style="flex: 1;">Ä°ptal</button>
                <button id="confirmUpdateButton" class="btn-success" style="flex: 1;">Onayla ve YÃ¼kle</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>AracÄ± Sil</h3>
            <p id="deleteModalMessage">Bu aracÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="cancelDeleteButton" class="btn-secondary" style="flex: 1;">Ä°ptal</button>
                <button id="confirmDeleteButton" class="btn-delete" style="flex: 1;">Evet, Sil</button>
            </div>
        </div>
    </div>


    <div id="universalModal" class="modal">
        <div class="modal-content">
            <h3 id="universalModalTitle"></h3>
            <p id="universalModalMessage" style="white-space: pre-wrap;"></p>
            <div id="universalModalButtons" style="display: flex; gap: 10px; margin-top: 20px;">
            </div>
        </div>
    </div>

    </div>


    <script>
        // UUIDs
        const GATE_SERVICE_UUID = "e3a1b2f0-5f4d-4c8a-bd2f-8e6a7f3b9c0d";
        const CHAR_SETTINGS_UUID = "a1d2f3e4-5678-4b9a-b3c2-9d8e7f6a5b4c";
        const CHAR_PIN_AUTH_UUID = "b2c3d4e5-6789-4f0b-c1d2-a3b4c5d6e7f8";
        const CHAR_DEVICE_MGMT_UUID = "d4e5f6a7-8901-4b2d-c3e4-f5a6b7c8d9e0";
        const CHAR_STATUS_UUID = "c3d4e5f6-7890-4a1c-b2d3-e4f5a6b7c8d9";
        // --- YENÄ° OTA KARAKTERÄ°STÄ°KLERÄ° ---
        const CHAR_OTA_CONTROL_UUID = "f0b1c2d3-e4f5-a6b7-c8d9-e0f1a2b3c4d5";
        const CHAR_OTA_DATA_UUID = "1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d";

        // Global variables
        let bleDevice, settingsCharacteristic, pinAuthCharacteristic, deviceMgmtCharacteristic, statusCharacteristic;
        let toastTimeout;
        let isPinInputModified = false;
        let deviceHasPin = false;
        let newFirmwareVersion = null;
        let firmwareBinUrl = null;

        let otaAckReceived = null;
        let otaAckPromiseResolver = null;

        let otaWindowSize = 20; // VarsayÄ±lan deÄŸer
        let otaChunkSize = 500;  // VarsayÄ±lan deÄŸer
        let otaShouldResend = false;
        let otaReadyPromiseResolver = null;
        let otaCurrentWindowId = 0;

        let isRebootRequired = false; // Yeniden baÅŸlatma gerekip gerekmediÄŸini takip eder







        // UI Elements
        const ui = {
            connectButton: document.getElementById('connectButton'),
            disconnectButton: document.getElementById('disconnectButton'),
            deviceNameDisplay: document.getElementById('deviceNameDisplay'),
            connectScreen: document.getElementById('connectScreen'),
            pinScreen: document.getElementById('pinScreen'),
            mainContent: document.getElementById('mainContent'),
            pinInput: document.getElementById('pinInput'),
            submitPinButton: document.getElementById('submitPinButton'),
            deviceList: document.getElementById('deviceList'),
            gateDeviceNameInput: document.getElementById('gateDeviceNameInput'), // ArtÄ±k HTML'de var
            closeTimeoutSlider: document.getElementById('closeTimeoutSlider'),
            closeTimeoutValue: document.getElementById('closeTimeoutValue'),
            preCloseWarningSlider: document.getElementById('preCloseWarningSlider'),
            preCloseWarningValue: document.getElementById('preCloseWarningValue'),
            operationModeSelect: document.getElementById('operationModeSelect'),
            authRequiredCheckbox: document.getElementById('authRequiredCheckbox'),
            securityWarning: document.getElementById('securityWarning'), // <<< YENÄ° SATIR

            saveSettingsButton: document.getElementById('saveSettingsButton'),
            toast: document.getElementById('toast'),
            newPinInput: document.getElementById('newPinInput'),
            pinStatus: document.getElementById('pinStatus'),

            scanButton: document.getElementById('scanButton'),
            scanProgressBar: document.getElementById('scanProgressBar'),
            scanProgressContainer: document.getElementById('scanProgressContainer'),
            foundDeviceModal: document.getElementById('foundDeviceModal'),

            // --- OTA UI ---
            updateUrlInput: document.getElementById('updateUrlInput'),
            firmwareVersionDisplay: document.getElementById('firmwareVersionDisplay'),
            checkUpdateButton: document.getElementById('checkUpdateButton'),
            startUpdateButton: document.getElementById('startUpdateButton'),
            otaUpdateContainer: document.getElementById('otaUpdateContainer'),
            otaProgressBar: document.getElementById('otaProgressBar'),
            otaProgressContainer: document.querySelector('#otaUpdateContainer .progress-container'),

            successModal: document.getElementById('successModal'),
            rebootDeviceButton: document.getElementById('rebootDeviceButton'),

            updateConfirmModal: document.getElementById('updateConfirmModal'),
            updateConfirmModalMessage: document.getElementById('updateConfirmModalMessage'),
            confirmUpdateButton: document.getElementById('confirmUpdateButton'),
            cancelUpdateButton: document.getElementById('cancelUpdateButton'),

            deleteConfirmModal: document.getElementById('deleteConfirmModal'),
            deleteModalMessage: document.getElementById('deleteModalMessage'),
            confirmDeleteButton: document.getElementById('confirmDeleteButton'),
            cancelDeleteButton: document.getElementById('cancelDeleteButton')


        };

        // Event Listeners
        ui.connectButton.addEventListener('click', connectToDevice);
        ui.disconnectButton.addEventListener('click', disconnectFromDevice);
        ui.submitPinButton.addEventListener('click', submitPin);
        ui.saveSettingsButton.addEventListener('click', writeGateSettings);
        ui.closeTimeoutSlider.addEventListener('input', e => ui.closeTimeoutValue.innerText = e.target.value);
        ui.preCloseWarningSlider.addEventListener('input', e => ui.preCloseWarningValue.innerText = e.target.value);

        ui.newPinInput.addEventListener('input', () => { isPinInputModified = true; });
        ui.authRequiredCheckbox.addEventListener('change', updateSecurityWarning);

        ui.scanButton.addEventListener('click', startVehicleScan);

        ui.checkUpdateButton.addEventListener('click', checkVersion);
        ui.startUpdateButton.addEventListener('click', startFirmwareUpdate);

        ui.rebootDeviceButton.addEventListener('click', () => {
            const rebootCommand = { command: "reboot" };
            try {
                otaControlCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(rebootCommand)));
            } catch (error) {
                console.log("Ignoring expected error on reboot command:", error.name);
            }
            ui.successModal.style.display = 'none';
            // Cihaz yeniden baÅŸlayacaÄŸÄ± iÃ§in baÄŸlantÄ±nÄ±n kopmasÄ±nÄ± bekliyoruz
            setTimeout(() => onDisconnected(false), 2000);
        });





        // <script> etiketi iÃ§inde -> Event Listeners bÃ¶lÃ¼mÃ¼ne ekleyin

        ui.cancelDeleteButton.addEventListener('click', () => {
            ui.deleteConfirmModal.style.display = 'none';
        });

        ui.confirmDeleteButton.addEventListener('click', async () => {
            // Butonun veri Ã¶zelliÄŸinden silinecek MAC adresini al
            const macToDelete = ui.confirmDeleteButton.dataset.mac;

            if (macToDelete) {
                const payload = { action: "delete_device", mac: macToDelete };
                await writeToDeviceMgmtChar(payload);
            }

            // Ä°ÅŸlem sonrasÄ± modalÄ± kapat
            ui.deleteConfirmModal.style.display = 'none';
        });

        ui.rebootDeviceButton.addEventListener('click', sendRebootCommand);



        // --- Core Functions ---

        function closeModal() { ui.foundDeviceModal.style.display = 'none'; }


        async function startDiscoveryScan() {
            showToast("Tarama baÅŸlatÄ±lÄ±yor...", "info");
            await writeToDeviceMgmtChar({ action: "start_discovery_scan" });
        }
        // VersiyonlarÄ± karÅŸÄ±laÅŸtÄ±ran yardÄ±mcÄ± fonksiyon (Ã¶r: "1.0.53" vs "1.0.55")
        function compareVersions(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);

            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const p1 = parts1[i] || 0; // EÄŸer parÃ§a yoksa 0 kabul et
                const p2 = parts2[i] || 0;

                if (p1 > p2) return 1; // v1 daha yeni
                if (p1 < p2) return -1; // v2 daha yeni
            }
            return 0; // Versiyonlar aynÄ±
        }

        function handleStatusNotifications(event) {
            const rawData = new TextDecoder().decode(event.target.value);
            let data;

            // Gelen verinin JSON olup olmadÄ±ÄŸÄ±nÄ± anlamak iÃ§in ayrÄ±ÅŸtÄ±rmayÄ± dene
            try {
                data = JSON.parse(rawData);
                console.log("BLE Notification Received:", data); // Gelen her JSON bildirimini konsola yazdÄ±r

            } catch (e) {
                // EÄŸer JSON deÄŸilse, bu "AUTH_SUCCESS" gibi basit bir metin mesajÄ±dÄ±r.
                // Bu panelde PIN yÃ¶netimi olmadÄ±ÄŸÄ± iÃ§in ÅŸimdilik sadece loglayabiliriz.
                console.log("Status update (text):", rawData);
                // Ã–rnek: if (rawData === "SETTINGS_UPDATED") { showToast("Ayarlar gÃ¼ncellendi!"); }
                return; // Metin tabanlÄ± bildirimden sonra iÅŸlemi bitir.
            }

            // EÄŸer veri JSON ise ve iÃ§inde bir "event" anahtarÄ± varsa...
            if (data && data.event) {

                switch (data.event) {


                    case 'ota_status':
                        showToast(data.message, data.type || 'info');
                        if (data.status === 'ready') {
                            // Device is ready, start sending firmware
                            sendFirmwareFile(data.firmwareBinary);
                        } else if (data.status === 'failed' || data.status === 'success') {
                            resetOtaUi();
                        }
                        if (data.reboot) {
                            setTimeout(() => onDisconnected(false), 2000);
                        }
                        break;

                    case 'ota_ready':
                        if (data.window !== undefined) {
                            otaCurrentWindowId = data.window;
                            console.log(`ğŸš€ OTA resume window ID cihazdan alÄ±ndÄ±: ${otaCurrentWindowId}`);
                        }
                        if (otaReadyPromiseResolver) {
                            otaReadyPromiseResolver(data.progress); // Mevcut ilerlemeyi ilet
                        }
                        break;

                    case 'ota_progress':
                        //const percent = Math.round((data.received / data.total) * 100);
                        const percent = data.progress;
                        ui.otaProgressBar.style.width = `${percent}%`;
                        ui.otaProgressBar.textContent = `${percent}%`;
                        break;

                    case 'ota_ack':

                        // Sadece beklediÄŸimiz pencerenin ACK'i geldiyse devam et
                        if (data.id === otaCurrentWindowId) {
                            if (otaAckPromiseResolver) {
                                otaAckPromiseResolver();
                                otaAckPromiseResolver = null;
                            }
                        } else {
                            console.log(`Received stray ACK for window ${data.id}, expecting ${otaCurrentWindowId}. Ignoring.`);
                        }
                        break;


                    case 'ota_nack':
                        showToast("Veri hatasÄ±! Paketler tekrar gÃ¶nderiliyor...", "error");
                        otaShouldResend = true;
                        if (otaAckPromiseResolver) {
                            otaAckPromiseResolver(); // Hata olsa bile bekleyen dÃ¶ngÃ¼yÃ¼ devam ettir
                        }
                        break;

                    case 'ota_config':
                        otaWindowSize = data.windowSize;
                        otaChunkSize = data.chunkSize;
                        console.log(`OTA configuration set by device: otaWindowSize=${otaWindowSize} otaChunkSize=${otaChunkSize}`);
                        break;

                    case 'device_found':

                        finishScanUI(true);

                        // Mevcut cihaz listesini al
                        deviceMgmtCharacteristic.readValue()
                            .then(value => {
                                const devices = JSON.parse(new TextDecoder().decode(value));
                                const existingDevice = devices.find(device => device.mac === data.mac);
                                const isPaired = !!existingDevice;

                                // Modal baÅŸlÄ±k ve buton metnini ayarla
                                const modalTitle = document.getElementById('modalTitle');
                                const pairButton = document.getElementById('pairButton');

                                if (isPaired) {
                                    modalTitle.innerText = "KayÄ±tlÄ± AraÃ§ Bulundu";
                                    pairButton.innerText = "GÃ¼ncelle";
                                } else {
                                    modalTitle.innerText = "Yeni AraÃ§ Bulundu";
                                    pairButton.innerText = "Ekle ve EÅŸleÅŸtir";
                                }

                                // Modal iÃ§eriÄŸini doldur
                                document.getElementById('foundDeviceName').innerText = data.deviceName || "Bilinmiyor";
                                document.getElementById('foundDeviceMac').innerText = data.mac;

                                // Nickname ayarla - kayÄ±tlÄ± araÃ§ta varsa onu gÃ¶ster, yoksa/yeni araÃ§sa deviceName gÃ¶ster
                                const nicknameInput = document.getElementById('nicknameInput');
                                if (isPaired && existingDevice.nickname) {
                                    nicknameInput.value = existingDevice.nickname;
                                } else {
                                    nicknameInput.value = data.deviceName || "";
                                }

                                // Buton click eventini ayarla
                                pairButton.onclick = () => {
                                    const payload = {
                                        action: isPaired ? "update_nickname" : "pair_new_device",
                                        mac: data.mac,
                                        vehicleName: data.deviceName,
                                        nickname: nicknameInput.value
                                    };
                                    writeToDeviceMgmtChar(payload);

                                    const actionText = isPaired ? "GÃ¼ncelleme" : "EÅŸleÅŸtirme";
                                    showToast(`${actionText} sÃ¼reci baÅŸlatÄ±ldÄ±...`, "info");
                                    closeModal();
                                };

                                ui.foundDeviceModal.style.display = 'flex';
                            })
                            .catch(error => {
                                console.error("Cihaz listesi okunamadÄ±:", error);
                                showToast("Cihaz durumu kontrol edilemedi", "error");
                            });
                        break;

                    case 'scan_failed':
                        // Tarama baÅŸarÄ±sÄ±z oldu olayÄ±
                        showToast("Tarama zaman aÅŸÄ±mÄ±na uÄŸradÄ±, yeni cihaz bulunamadÄ±.", "error");
                        break;

                    case 'pairing_complete':

                        document.body.classList.remove('scanning');
                        ui.scanButton.innerText = "YakÄ±ndaki AraÃ§larÄ± Tara";
                        ui.scanButton.disabled = false;

                        // EÅŸleÅŸme tamamlandÄ± olayÄ± (gelecekteki kullanÄ±m iÃ§in)
                        showToast("Yeni cihaz baÅŸarÄ±yla eÅŸleÅŸtirildi!", "success");
                        setTimeout(renderDeviceList, 1000); // Listeyi 1 saniye sonra yenile
                        break;

                    case 'update_status':
                        if (data.reboot) { // BaÅŸarÄ±lÄ± gÃ¼ncelleme
                            isRebootRequired = true;
                            updateRebootButtonState(); // Butonu kÄ±rmÄ±zÄ± yap
                            showModal({
                                title: "Ä°ÅŸlem BaÅŸarÄ±lÄ±!",
                                message: data.message,
                                buttons: [
                                    { text: "CihazÄ± Yeniden BaÅŸlat", class: "btn-success", onClick: sendRebootCommand }
                                ]
                            });
                        } else {
                            showToast(data.message, data.type || 'info');
                        }
                        break;
                    case 'reboot_required':
                        // 1. KalÄ±cÄ± yeniden baÅŸlatma bayraÄŸÄ±nÄ± ayarla
                        isRebootRequired = true;
                        // 2. Arka plandaki ana butonu hemen kÄ±rmÄ±zÄ± yap
                        updateRebootButtonState();
                        // 3. KullanÄ±cÄ±ya nedenini aÃ§Ä±klayan bir modal gÃ¶ster
                        showModal({
                            title: "Yeniden BaÅŸlatma Gerekli",
                            message: data.reason || "YapÄ±lan bazÄ± deÄŸiÅŸikliklerin etkili olmasÄ± iÃ§in cihazÄ±n yeniden baÅŸlatÄ±lmasÄ± gerekiyor.",
                            buttons: [
                                { text: "Daha Sonra", class: "btn-secondary" }, // Bu buton sadece modalÄ± kapatÄ±r
                                {
                                    text: "Åimdi Yeniden BaÅŸlat",
                                    delay: 3,
                                    class: "btn-delete", // KÄ±rmÄ±zÄ± ve dikkat Ã§ekici
                                    onClick: sendRebootCommand // Daha Ã¶nce yazdÄ±ÄŸÄ±mÄ±z yeniden baÅŸlatma fonksiyonunu Ã§aÄŸÄ±r
                                }
                            ]
                        });
                        break;

                    // Buraya gelecekte baÅŸka event'ler eklenebilir
                }
            }
        }


        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
        }

        function showTab(tabId, clickedButton) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                const btnId = `tabBtn${tabId.replace('Screen', '')}`;
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.add('active');
            }
        }

        async function connectToDevice() {
            try {
                showToast("Cihaz aranÄ±yor...");
                bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [GATE_SERVICE_UUID] }] });
                showToast("Cihaza baÄŸlanÄ±lÄ±yor...");
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(GATE_SERVICE_UUID);
                settingsCharacteristic = await service.getCharacteristic(CHAR_SETTINGS_UUID);
                pinAuthCharacteristic = await service.getCharacteristic(CHAR_PIN_AUTH_UUID);
                deviceMgmtCharacteristic = await service.getCharacteristic(CHAR_DEVICE_MGMT_UUID);

                // 1. Durum (Status) KarakteristiÄŸine EriÅŸ
                statusCharacteristic = await service.getCharacteristic(CHAR_STATUS_UUID);

                otaControlCharacteristic = await service.getCharacteristic(CHAR_OTA_CONTROL_UUID);
                otaDataCharacteristic = await service.getCharacteristic(CHAR_OTA_DATA_UUID);


                // 2. Bu karakteristikten gelecek bildirimleri dinlemeye baÅŸla
                await statusCharacteristic.startNotifications();
                statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusNotifications);


                ui.deviceNameDisplay.innerText = bleDevice.name || 'GATE';
                ui.deviceNameDisplay.style.display = 'block';

                await checkPinRequirement();
            } catch (error) {
                console.error("BaÄŸlantÄ± hatasÄ±:", error);
                showToast("BaÄŸlantÄ± kurulamadÄ±.", "error");
            }
        }

        async function checkPinRequirement() {
            try {
                const value = await pinAuthCharacteristic.readValue();
                const response = JSON.parse(new TextDecoder().decode(value));
                if (response.pinRequired) {
                    showScreen('pinScreen');
                } else {
                    showToast("PIN gerekli deÄŸil, ana ekrana geÃ§iliyor...", "success");
                    await showMainContentAndLoadData();
                }
            } catch (error) { showToast("PIN durumu okunamadÄ±.", "error"); }
        }

        async function submitPin() {
            const pin = ui.pinInput.value;
            if (pin.length !== 4) { showToast("PIN 4 haneli olmalÄ±."); return; }
            try {
                await pinAuthCharacteristic.writeValue(new TextEncoder().encode(pin));
                showToast("PIN gÃ¶nderildi, ayarlar okunuyor...");
                await showMainContentAndLoadData();
            } catch (error) { showToast("PIN gÃ¶nderilemedi veya yanlÄ±ÅŸ.", "error"); }
        }


        function startVehicleScan() {



            // EÄŸer zaten tarama yapÄ±lÄ±yorsa, tekrar baÅŸlatma
            if (document.body.classList.contains('scanning')) return;

            // Animasyonu baÅŸlatmak iÃ§in body'e class ekle
            document.body.classList.add('scanning');

            // Tarama baÅŸladÄ±ÄŸÄ±nda butonun metnini deÄŸiÅŸtir ve pasif yap
            ui.scanButton.innerText = "TaranÄ±yor...";
            ui.scanButton.disabled = true;

            // Ä°lerleme Ã§ubuÄŸunu gÃ¶ster
            ui.scanProgressContainer.style.display = 'block';

            showToast("YakÄ±ndaki araÃ§lar 10 saniye boyunca taranÄ±yor...", "info");

            // BU NOKTADA, GATE'E TARAMAYI BAÅLATMASI Ä°Ã‡Ä°N BLE KOMUTU GÃ–NDERÄ°LÄ°R
            const payload = { action: "start_discovery_scan" };
            writeToDeviceMgmtChar(payload);

            // 10 saniye sonra animasyonu ve buton durumunu sÄ±fÄ±rla
            scanTimeoutId = setTimeout(() => { // ZamanlayÄ±cÄ±yÄ± bir ID'ye ata
                finishScanUI(false); // Zaman aÅŸÄ±mÄ±nda toast gÃ¶ster
                showToast("Tarama zaman aÅŸÄ±mÄ±na uÄŸradÄ±, yeni cihaz bulunamadÄ±.", "error"); //
            }, 10000);
        }

        function finishScanUI(suppressToast = false) { // suppressToast parametresi eklendi
            document.body.classList.remove('scanning');
            ui.scanButton.innerText = "YakÄ±ndaki AraÃ§larÄ± Tara";
            ui.scanButton.disabled = false;
            ui.scanProgressContainer.style.display = 'none';

            // EÄŸer toast gÃ¶sterilmemesi istenmiyorsa
            if (!suppressToast) { //
                showToast("Tarama tamamlandÄ±.", "success"); //
            }

            // ZamanlayÄ±cÄ±yÄ± temizle
            if (scanTimeoutId) { //
                clearTimeout(scanTimeoutId); //
                scanTimeoutId = null; //
            }
        }

        async function showMainContentAndLoadData() {
            showScreen('mainContent');
            showTab('deviceManagementScreen', document.getElementById('tabBtnDeviceMgmt'));
            await renderDeviceList();
            await readGateSettings();
        }

        // --- Data Handling Functions ---

        async function renderDeviceList() {
            if (!deviceMgmtCharacteristic) return;
            try {
                const value = await deviceMgmtCharacteristic.readValue();
                const devices = JSON.parse(new TextDecoder().decode(value));
                ui.deviceList.innerHTML = '';

                if (devices.length === 0) {
                    ui.deviceList.innerHTML = '<p style="text-align:center; color:#888;">KayÄ±tlÄ± araÃ§ bulunmuyor.</p>';
                    return;
                }

                devices.forEach(device => {
                    const item = document.createElement('div');
                    item.className = 'device-item';
                    // CihazÄ±n kendi adÄ±nÄ± da (varsa) gÃ¶steriyoruz.
                    const vehicleNameDisplay = device.vehicleName ? `<strong class="vehicle-name">${device.vehicleName}</strong>` : '';

                    item.innerHTML = `
            <div class="device-info">
                <input type="text" value="${device.nickname}" id="nick-${device.mac}" placeholder="Takma Ä°sim">
                <div class="device-details">
                    ${vehicleNameDisplay}
                    <span class="mac-address">${device.mac}</span>
                </div>
            </div>
            <div class="device-actions">
                <button onclick="updateNickname('${device.mac}')">GÃ¼ncelle</button>
                <button class="btn-delete" onclick="deleteDevice('${device.mac}')">Sil</button>
            </div>
        `;
                    ui.deviceList.appendChild(item);
                });
            } catch (error) {
                console.error("Cihaz listesi okunamadÄ±:", error);
                showToast("Cihaz listesi okunamadÄ±. PIN yanlÄ±ÅŸ olabilir.", "error");
                showScreen('pinScreen');
            }
        }

        async function updateNickname(mac) {
            const nickname = document.getElementById(`nick-${mac}`).value;
            const payload = { action: "update_nickname", mac: mac, nickname: nickname };
            await writeToDeviceMgmtChar(payload);
        }



        async function writeToDeviceMgmtChar(payload) {
            try {
                await deviceMgmtCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(payload)));
                showToast("Komut gÃ¶nderildi...", "success");
                setTimeout(renderDeviceList, 750);
            } catch (error) {
                console.error("Komut gÃ¶nderilemedi:", error);
                showToast("Komut gÃ¶nderilemedi.", "error");
            }
        }

        async function readGateSettings() {
            try {


                const value = await settingsCharacteristic.readValue();
                const settings = JSON.parse(new TextDecoder().decode(value));
                if (settings.error) {
                    showToast("Yetki gerekli: " + settings.error, "error");
                    showScreen('pinScreen');
                    return;
                }

                const deviceName = settings.deviceName || 'GATE';


                ui.gateDeviceNameInput.value = settings.deviceName || '';
                ui.closeTimeoutSlider.value = settings.closeTimeout || 30;
                ui.closeTimeoutValue.innerText = settings.closeTimeout || 30;
                ui.preCloseWarningSlider.value = settings.preCloseWarning || 5;
                ui.preCloseWarningValue.innerText = settings.preCloseWarning || 5;
                ui.operationModeSelect.value = settings.opMode || 0;
                ui.authRequiredCheckbox.checked = settings.authReq !== false;
                ui.firmwareVersionDisplay.textContent = settings.firmwareVersion || 'Bilinmiyor';


                // Ayarlar okunduktan sonra uyarÄ±nÄ±n ilk durumunu ayarla
                updateSecurityWarning(); // <<< YENÄ° SATIR

                deviceHasPin = settings.pinExists; // Cihazda PIN olup olmadÄ±ÄŸÄ±nÄ± kaydet


                if (settings.pinExists) {
                    ui.newPinInput.value = "****"; // Mevcut PIN'i gÃ¶sterme, sadece maskele
                    ui.newPinInput.placeholder = "DeÄŸiÅŸtirmek iÃ§in yeni PIN girin";
                    document.getElementById('pinRemoveHint').textContent = "(KaldÄ±rmak iÃ§in boÅŸ bÄ±rakÄ±n)";

                    ui.pinStatus.innerText = "Cihaz PIN ile korunuyor.";
                    ui.pinStatus.style.color = "#007AFF";
                } else {
                    ui.newPinInput.value = "";
                    ui.newPinInput.placeholder = "Yeni PIN (4 hane)";
                    document.getElementById('pinRemoveHint').textContent = "";

                    ui.pinStatus.innerText = "âš ï¸ PIN ayarlÄ± deÄŸil! Herkes ayarlara eriÅŸebilir.";
                    ui.pinStatus.style.color = "#D32F2F"; // Dikkat Ã§ekici kÄ±rmÄ±zÄ± renk
                }
                isPinInputModified = false; // BayraÄŸÄ± sÄ±fÄ±rla

            } catch (error) {
                console.error("Gate ayarlarÄ± okunurken hata:", error);
                showToast("Gate ayarlarÄ± okunamadÄ±. PIN yanlÄ±ÅŸ olabilir.", "error");
                showScreen('pinScreen');
            }
        }

        // gate-admin-panel.html -> Bu fonksiyonu mevcut olanla tamamen deÄŸiÅŸtirin
        async function writeGateSettings() {
            try {
                // 1. Ã–nce, PIN dÄ±ÅŸÄ±ndaki tÃ¼m ayarlarÄ± bir nesnede topla
                const settingsPayload = {
                    deviceName: ui.gateDeviceNameInput.value,
                    closeTimeout: parseInt(ui.closeTimeoutSlider.value, 10),
                    preCloseWarning: parseInt(ui.preCloseWarningSlider.value, 10),
                    opMode: parseInt(ui.operationModeSelect.value, 10),
                    authReq: ui.authRequiredCheckbox.checked
                };




                // 2. EÄŸer kullanÄ±cÄ± PIN kutusuna hiÃ§ dokunmadÄ±ysa, sadece bu ayarlarÄ± gÃ¶nder ve Ã§Ä±k.
                if (!isPinInputModified) {
                    await settingsCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(settingsPayload)));
                    showToast("Ayarlar kaydedildi.", "success");
                    updateRebootButtonState();

                    setTimeout(readGateSettings, 1500);
                    return;
                }

                // 3. EÄŸer PIN kutusu deÄŸiÅŸtirildiyse...
                const newPin = ui.newPinInput.value;

                // Senaryo A: PIN silinmek isteniyor (kutu boÅŸ bÄ±rakÄ±ldÄ±)
                if (newPin.length === 0) {
                    if (deviceHasPin) {
                        showModal({
                            title: "PIN Silme OnayÄ±",
                            message: "Mevcut PIN'i kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?",
                            buttons: [
                                { text: "Ä°ptal", class: "btn-secondary" },
                                {
                                    text: "Evet, Sil",
                                    class: "btn-delete",
                                    delay: 3,
                                    onClick: async () => {
                                        // <<< DÃœZELTME BURADA >>>
                                        // Sadece PIN'i silen bir payload oluÅŸturmak yerine,
                                        // ana ayarlarla PIN silme komutunu birleÅŸtiriyoruz.
                                        const fullPayload = { ...settingsPayload, pinCode: "" };
                                        await settingsCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(fullPayload)));

                                        showToast("PIN baÅŸarÄ±yla silindi ve diÄŸer ayarlar kaydedildi.", "success");
                                        isPinInputModified = false;
                                        setTimeout(readGateSettings, 1500);
                                    }
                                }
                            ]
                        });
                    }
                    // Zaten PIN yoksa ve kutu boÅŸ bÄ±rakÄ±ldÄ±ysa bir ÅŸey yapmaya gerek yok.
                }
                // Senaryo B: Yeni bir PIN ayarlanÄ±yor
                else {
                    if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                        showToast("Yeni PIN 4 haneli bir sayÄ± olmalÄ±dÄ±r!", "error");
                        return;
                    }
                    // Hem normal ayarlarÄ± hem de yeni PIN'i birleÅŸtir ve gÃ¶nder.
                    const fullPayload = { ...settingsPayload, pinCode: newPin };
                    await settingsCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(fullPayload)));

                    showToast("Ayarlar ve yeni PIN kaydedildi.", "success");
                    isPinInputModified = false;
                    setTimeout(readGateSettings, 1500);
                }

            } catch (error) {
                console.error("Gate ayarlarÄ± kaydedilemedi:", error);
                showToast("Ayarlar kaydedilemedi.", "error");
            }

            if (isRebootRequired) {
                updateRebootButtonState();
            }
        }


        // --- NEW OTA FUNCTIONS ---

        function resetOtaUi() {
            isUpdateInProgress = false;
            ui.startUpdateButton.style.display = 'none';
            ui.checkUpdateButton.style.display = 'block';
            ui.checkUpdateButton.disabled = false;
            ui.otaProgressContainer.style.display = 'none';
            ui.otaProgressBar.style.width = '0%';
            ui.otaProgressBar.textContent = '0%';
            firmwareBinUrl = null;
        }

        async function checkVersion() {
            const url = ui.updateUrlInput.value;
            const currentVersion = ui.firmwareVersionDisplay.textContent;

            if (!url) {
                showToast("LÃ¼tfen bir Update URL girin.", "error");
                return;
            }
            if (currentVersion === "Bilinmiyor" || !currentVersion) {
                showToast("Mevcut firmware versiyonu okunamadÄ±. LÃ¼tfen ayarlarÄ± yenileyin.", "error");
                return;
            }

            ui.checkUpdateButton.disabled = true;
            showToast("Versiyon kontrol ediliyor...");

            try {
                // Ã–nbelleÄŸi atlamak iÃ§in parametre ekliyoruz.
                // Bu, sunucunun her zaman en gÃ¼ncel dosyayÄ± gÃ¶ndermesini saÄŸlar.
                const cacheBustedUrl = `${url}?_=${new Date().getTime()}`;
                const response = await fetch(cacheBustedUrl, { cache: 'no-cache' }); // Ek gÃ¼venlik iÃ§in no-cache de ekledik

                if (!response.ok) {
                    throw new Error(`Sunucu hatasÄ±! Status: ${response.status}`);
                }

                const versionInfo = await response.json();
                const latestVersion = versionInfo.latest_version;
                firmwareBinUrl = versionInfo.bin_url;



                if (!latestVersion) {
                    showToast("GÃ¼ncelleme sunucusundan geÃ§ersiz versiyon bilgisi alÄ±ndÄ±.", "error");
                    ui.checkUpdateButton.disabled = false;
                    return;
                }

                // Yeni karÅŸÄ±laÅŸtÄ±rma fonksiyonunu kullan
                const comparisonResult = compareVersions(currentVersion, latestVersion);

                if (true || comparisonResult === -1) { // -1 demek: currentVersion < latestVersion
                    showModal({
                        title: "Yeni GÃ¼ncelleme Bulundu!",
                        message: `Mevcut Versiyon: <b>${currentVersion}</b><br>Yeni Versiyon: <b>${latestVersion}</b><br><br>GÃ¼ncellemeyi baÅŸlatmak iÃ§in onaylayÄ±n.`,
                        buttons: [
                            { text: "Ä°ptal", class: "btn-secondary", onClick: resetOtaUi },
                            { text: "Onayla ve YÃ¼kle", class: "btn-success", onClick: startFirmwareUpdate }
                        ]
                    });


                } else if (comparisonResult === 1) { // 1 demek: currentVersion > latestVersion
                    showToast(`CihazÄ±nÄ±zda daha yeni bir versiyon var: ${currentVersion}. Sunucu versiyonu: ${latestVersion}`, "info");
                    ui.checkUpdateButton.disabled = false;
                }
                else { // 0 demek: Versiyonlar aynÄ±
                    showToast("CihazÄ±nÄ±z gÃ¼ncel.", "info");
                    ui.checkUpdateButton.disabled = false;
                }

            } catch (error) {
                console.error("Version check failed:", error);
                showToast(`Versiyon kontrolÃ¼ baÅŸarÄ±sÄ±z oldu: ${error.message}`, "error");
                ui.checkUpdateButton.disabled = false;

            } finally {
                // --- BU BLOK GÃœNCELLENDÄ° ---
                // Butonu her zaman tekrar aktif hale getir, Ã§Ã¼nkÃ¼ onay modalda verilecek
                ui.checkUpdateButton.disabled = false;
            }
        }

        // gate-admin-panel.html -> <script> etiketi iÃ§indeki bu fonksiyonu gÃ¼ncelleyin

        async function startFirmwareUpdate() {



            if (!firmwareBinUrl) {
                showToast("Firmware URL'i bulunamadÄ±.", "error");
                return;
            }


            isUpdateInProgress = true;
            ui.checkUpdateButton.style.display = 'none'; // "Kontrol Et" butonunu gizle
            ui.startUpdateButton.style.display = 'none'; // "YÃ¼kle" butonunu da gizle
            ui.otaProgressContainer.style.display = 'block'; // Sadece progress bar gÃ¶rÃ¼nsÃ¼n

            try {
                showToast("Firmware indiriliyor...", "info");
                const response = await fetch(`${firmwareBinUrl}?v=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Download failed: ${response.statusText}`);
                const firmwareBinary = await response.arrayBuffer();

                showToast("Cihaz hazÄ±rlanÄ±yor...", "info");
                const startCommand = { command: "start", size: firmwareBinary.byteLength };

                // Cihazdan "ota_ready" ve mevcut ilerleme bilgisini bekle
                const readyPromise = new Promise(resolve => { otaReadyPromiseResolver = resolve; });
                await otaControlCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(startCommand)));
                const initialProgress = await readyPromise;

                // 5 paketlik bir geri sarma yap
                const rewindBytes = 5 * otaChunkSize;
                let startByte = initialProgress > rewindBytes ? initialProgress - rewindBytes : 0;

                showToast(`GÃ¼ncellemeye ${Math.round((startByte / firmwareBinary.byteLength) * 100)}% noktasÄ±ndan devam ediliyor...`, "info");

                // GÃ¶nderimi geri sarÄ±lmÄ±ÅŸ noktadan baÅŸlat
                await sendFirmwareFile(firmwareBinary, startByte);

            } catch (error) {
                console.error("Firmware update failed:", error);
                showToast(`Hata: ${error.message}`, "error");
                resetOtaUi();
            }
        }




        // Bu fonksiyonu HTML dosyanÄ±zdaki mevcut olanla tamamen deÄŸiÅŸtirin
        async function sendFirmwareFile(firmwareBinary, startFromByte = 0) {
            showToast("Firmware cihaza yÃ¼kleniyor...", "info");
            const totalChunks = Math.ceil(firmwareBinary.byteLength / otaChunkSize);
            const windowSize = otaWindowSize;
            let chunksSentInWindow = 0;
            let startChunk = Math.floor(startFromByte / otaChunkSize);
            let windowStartIndex = startChunk;

            otaCurrentWindowId = Math.floor(startChunk / windowSize);

            const totalWindows = Math.ceil(totalChunks / windowSize);
            console.log(`ğŸš€ OTA DEBUG:
    Firmware size: ${firmwareBinary.byteLength} bytes
    Chunk size: ${otaChunkSize}
    Window size: ${otaWindowSize}
    Total chunks: ${totalChunks}
    Total windows: ${totalWindows}`);


            for (let i = startChunk; i < totalChunks; i++) {
                if (!isUpdateInProgress) {
                    showToast("GÃ¼ncelleme iptal edildi.", "info");
                    const abortCommand = { command: "abort" };
                    await otaControlCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(abortCommand)));
                    return;
                }

                const chunkData = firmwareBinary.slice(i * otaChunkSize, (i + 1) * otaChunkSize);
                const crc = calculateCrc32(chunkData);
                const packet = new ArrayBuffer(4 + chunkData.byteLength);
                const packetView = new DataView(packet);
                packetView.setUint32(0, crc, true);
                new Uint8Array(packet, 4).set(new Uint8Array(chunkData));

                await otaDataCharacteristic.writeValueWithoutResponse(packet);
                chunksSentInWindow++;

                // Stabilite iÃ§in bu gecikme kritik Ã¶neme sahiptir.
                await new Promise(resolve => setTimeout(resolve, 5));

                if (chunksSentInWindow >= windowSize && i < totalChunks - 1) {


                    console.log(`Window sent (${chunksSentInWindow} chunks). Waiting for ACK...`);
                    const ackPromise = new Promise(resolve => { otaAckPromiseResolver = resolve; });
                    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("OTA ACK Timeout")), 10000));

                    await Promise.race([ackPromise, timeoutPromise]);

                    if (otaShouldResend) {
                        i = windowStartIndex - 1;
                        otaShouldResend = false;
                        chunksSentInWindow = 0;
                        console.log("NACK received. Resending window...");
                        continue;
                    }

                    console.log("ACK Received. Continuing...");
                    windowStartIndex = i + 1;
                    otaCurrentWindowId++; // Bir sonraki pencere iÃ§in beklenen ID'yi artÄ±r
                    chunksSentInWindow = 0;
                }
            }

            showToast("YÃ¼kleme tamamlandÄ±, cihaz doÄŸrulanÄ±yor...", "info");
            const endCommand = { command: "end" };
            await otaControlCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(endCommand)));
        }




        // --- UI/Helper Functions ---
        function onDisconnected() {
            showToast("Cihaz baÄŸlantÄ±sÄ± koptu.", "error");
            showScreen('connectScreen');
            ui.deviceNameDisplay.style.display = 'none';
        }

        async function disconnectFromDevice() {
            if (bleDevice && bleDevice.gatt.connected) {
                await bleDevice.gatt.disconnect();
            }
        }

        function updateSecurityWarning() {
            if (ui.authRequiredCheckbox.checked) {
                ui.securityWarning.style.display = 'none';
            } else {
                ui.securityWarning.style.display = 'block';
            }
        }


        async function deleteDevice(mac) {
            showModal({
                title: "Cihaz Silme OnayÄ±",
                message: `MAC Adresi: <b>${mac}</b><br><br>Bu aracÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`,
                buttons: [
                    { text: "Ä°ptal", class: "btn-secondary" },
                    {
                        text: "Evet, Sil",
                        class: "btn-delete",
                        onClick: async () => {
                            const payload = { action: "delete_device", mac: mac };
                            await writeToDeviceMgmtChar(payload);
                        }
                    }
                ]
            });
        }

        async function sendRebootCommand() {
    // --- BÃ–LÃœM 1: ARAYÃœZ GÃœNCELLEMELERÄ° (ANINDA Ã‡ALIÅIR) ---

    // 1. BayraÄŸÄ± ve buton rengini hemen sÄ±fÄ±rla
    isRebootRequired = false;
    updateRebootButtonState();

    // 2. Geri sayÄ±m modalÄ±nÄ± hemen gÃ¶ster
    let countdown = 3;
    showModal({
        title: "Cihaz Yeniden BaÅŸlatÄ±lÄ±yor",
        message: `Sayfa <strong>${countdown}</strong> saniye iÃ§inde yenilenecek...`,
        buttons: [] // Buton olmasÄ±n
    });

    // 3. Geri sayÄ±m sayacÄ±nÄ± hemen baÅŸlat
    const modalMessageEl = document.getElementById('universalModalMessage');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            modalMessageEl.innerHTML = `Sayfa <strong>${countdown}</strong> saniye iÃ§inde yenilenecek...`;
        } else {
            clearInterval(countdownInterval);
            modalMessageEl.innerHTML = "Åimdi yenileniyor...";
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }, 1000);

    // --- BÃ–LÃœM 2: BLUETOOTH KOMUTU (ARKA PLANDA Ã‡ALIÅIR) ---

    // 4. Komutu "beklemeden" gÃ¶nder. ArayÃ¼zÃ¼mÃ¼z zaten Ã§alÄ±ÅŸÄ±yor.
    const rebootCommand = { command: "reboot" };
    try {
        if (bleDevice && bleDevice.gatt.connected && otaControlCharacteristic) {
            // DÄ°KKAT: Bu satÄ±rÄ±n baÅŸÄ±nda 'await' YOK.
            // Bu sayede komut gÃ¶nderilir ve kod akÄ±ÅŸÄ± anÄ±nda devam eder.
            otaControlCharacteristic.writeValue(new TextEncoder().encode(JSON.stringify(rebootCommand)));
        }
    } catch (error) {
        // Bu hata bloÄŸu sadece komut gÃ¶nderilirken anlÄ±k bir sorun olursa Ã§alÄ±ÅŸÄ±r.
        // CihazÄ±n baÄŸlantÄ±sÄ±nÄ±n kopmasÄ± beklenen bir durum olduÄŸu iÃ§in sorun teÅŸkil etmez.
        console.log("Reboot command sent. Ignoring expected disconnection error:", error.name);
    }
}

        function updateRebootButtonState() {
            if (isRebootRequired) {
                // Yeniden baÅŸlatma GEREKLÄ° ise, butonu kÄ±rmÄ±zÄ± yap
                ui.rebootDeviceButton.classList.remove('btn-secondary');
                ui.rebootDeviceButton.classList.add('btn-delete'); // KÄ±rmÄ±zÄ± stil iÃ§in mevcut class'Ä± kullanalÄ±m
            } else {
                // Yeniden baÅŸlatma gerekli DEÄÄ°LSE, butonu normal gri yap
                ui.rebootDeviceButton.classList.remove('btn-delete');
                ui.rebootDeviceButton.classList.add('btn-secondary');
            }
        }

        function showToast(message, type = "info") {
            const toast = ui.toast;
            toast.textContent = message;
            toast.style.display = 'block';
            toast.style.backgroundColor = type === "success" ? '#4CAF50' : (type === "error" ? '#f44336' : 'rgba(0,0,0,0.75)');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }


        // <script> etiketi iÃ§ine ekleyin

        // Evrensel modalÄ± yÃ¶neten ana fonksiyon
        function showModal(options) {
            const {
                title,
                message,
                buttons = [], // VarsayÄ±lan olarak boÅŸ buton dizisi
                autoClose = 0 // VarsayÄ±lan olarak otomatik kapanma yok
            } = options;

            const modal = document.getElementById('universalModal');
            const titleEl = document.getElementById('universalModalTitle');
            const messageEl = document.getElementById('universalModalMessage');
            const buttonsEl = document.getElementById('universalModalButtons');

            // Ä°Ã§eriÄŸi temizle ve doldur
            titleEl.innerText = title;
            messageEl.innerHTML = message; // HTML iÃ§eriÄŸine izin vermek iÃ§in .innerHTML kullanÄ±yoruz
            buttonsEl.innerHTML = ''; // Ã–nceki butonlarÄ± temizle

            // ButonlarÄ± oluÅŸtur
            if (buttons.length > 0) {
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.innerText = btnInfo.text;
                    button.className = btnInfo.class || 'btn-secondary'; // VarsayÄ±lan stil
                    button.style.flex = 1;

                    const originalText = btnInfo.text;

                    // EÄŸer butonda gecikme varsa...
                    if (btnInfo.delay && btnInfo.delay > 0) {
                        button.disabled = true;
                        let countdown = btnInfo.delay;
                        button.innerText = `${originalText} (${countdown})`;

                        const interval = setInterval(() => {
                            countdown--;
                            button.innerText = `${originalText} (${countdown})`;
                            if (countdown <= 0) {
                                clearInterval(interval);
                                button.innerText = originalText;
                                button.disabled = false;
                            }
                        }, 1000);
                    }

                    button.onclick = () => {
                        modal.style.display = 'none'; // Butona tÄ±klanÄ±nca modalÄ± her zaman kapat
                        if (btnInfo.onClick) {
                            btnInfo.onClick(); // Butonun Ã¶zel eylemini Ã§alÄ±ÅŸtÄ±r
                        }
                    };
                    buttonsEl.appendChild(button);
                });
            }

            // ModalÄ± gÃ¶ster
            modal.style.display = 'flex';

            // EÄŸer otomatik kapanma sÃ¼resi varsa...
            if (autoClose > 0) {
                setTimeout(() => {
                    modal.style.display = 'none';
                }, autoClose * 1000);
            }
        }




        // CRC32 hesaplama fonksiyonu ve tablosu
        const crc32Table = (() => {
            let c, table = [];
            for (let n = 0; n < 256; n++) {
                c = n;
                for (let k = 0; k < 8; k++) {
                    c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
                }
                table[n] = c;
            }
            return table;
        })();

        function calculateCrc32(buffer) {
            let crc = 0 ^ (-1);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < view.length; i++) {
                crc = (crc >>> 8) ^ crc32Table[(crc ^ view[i]) & 0xFF];
            }
            return (crc ^ (-1)) >>> 0;
        };


    </script>
</body>

</html>